name: CI Status Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  # ç­‰å¾…æ‰€æœ‰å…³é”®æ£€æŸ¥å®Œæˆ
  all-checks:
    name: All CI Checks Status
    runs-on: ubuntu-latest
    needs: []
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: CI Status Summary
        run: |
          echo "## âœ… CI Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All automated checks have been triggered:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **Code Quality**: Super Linter + ReviewDog" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **Security Analysis**: CodeQL (Python + JavaScript)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›¡ï¸ **Vulnerability Scan**: Trivy (Dependencies + Docker)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ **Dependency Review**: Safety + NPM Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check individual workflow results for details." >> $GITHUB_STEP_SUMMARY

      - name: Create Initial PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const message = `## ğŸ¤– CI/CD Pipeline - Automated Checks
            
            Thank you for your contribution! The following automated checks are now running on your PR:
            
            ### ğŸ“‹ Check Status
            
            | Category | Tool | Status | Details |
            |----------|------|--------|---------|
            | **ğŸ” Code Quality** | Super Linter | ğŸ”„ Running... | Style & syntax checks |
            | **ğŸ” Code Quality** | ESLint | ğŸ”„ Running... | JavaScript linting |
            | **ğŸ” Code Quality** | Flake8 | ğŸ”„ Running... | Python linting |
            | **ğŸ” Code Quality** | Hadolint | ğŸ”„ Running... | Dockerfile linting |
            | **ğŸ” Code Quality** | Markdownlint | ğŸ”„ Running... | Markdown formatting |
            | **ğŸ” Security** | CodeQL (Python) | ğŸ”„ Running... | Code security analysis |
            | **ğŸ” Security** | CodeQL (JavaScript) | ğŸ”„ Running... | Code security analysis |
            | **ğŸ›¡ï¸ Dependencies** | Trivy | ğŸ”„ Running... | CVE vulnerability scan |
            | **ğŸ›¡ï¸ Dependencies** | Safety | ğŸ”„ Running... | Python packages |
            | **ğŸ›¡ï¸ Dependencies** | NPM Audit | ğŸ”„ Running... | NPM packages |
            | **ğŸ“ Review** | Dependency Review | ğŸ”„ Running... | Dependency changes |
            
            ---
            
            ### ğŸ“š What happens next?
            
            1. **Code Review Comments**: ReviewDog will add inline comments on any issues found in your code
            2. **Security Alerts**: Security findings will appear in the [Security tab](https://github.com/${{ github.repository }}/security)
            3. **Individual Reports**: Each tool will post its own summary comment below
            4. **Overall Status**: Check the "Checks" tab for pass/fail status
            
            ### ğŸ› ï¸ If checks fail:
            
            **Code Quality Issues:**
            \`\`\`bash
            # Run locally before pushing
            ./scripts/pre-commit-check.sh
            
            # Quick fixes
            black backend/                              # Python formatting
            npx eslint --fix backend/static/**/*.js     # JavaScript fixes
            \`\`\`
            
            **Security/Dependency Issues:**
            - Check the detailed comments below
            - Review the Security tab for vulnerabilities
            - Update packages: \`pip install --upgrade <package>\` or \`npm audit fix\`
            
            ---
            
            *ğŸ’¡ Tip: All checks are fully automated and free. They run on every push to help maintain code quality and security.*
            
            *â±ï¸ Estimated completion time: 5-8 minutes*
            `;
            
            // Check if initial comment already exists
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CI/CD Pipeline - Automated Checks')
            );
            
            if (!existingComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
