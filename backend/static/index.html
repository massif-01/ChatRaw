<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ChatRaw</title>
    <link rel="icon" id="favicon" href="data:,">
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.13.3/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/marked@9.1.6/marked.min.js"></script>
    <!-- highlight.js core + common languages only (~50KB vs ~500KB) -->
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/python.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/javascript.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/bash.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/json.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/sql.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/xml.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/css.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="styles.css?v=4.0">
</head>
<body x-data="app()" x-init="init()" :data-theme="settings.ui_settings.theme_mode">
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" x-show="!sidebarCollapsed" @click="sidebarCollapsed = true" x-transition:enter="fade-enter" x-transition:leave="fade-leave"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" :class="{ 'collapsed': sidebarCollapsed }">
        <div class="sidebar-header">
            <div class="logo" x-show="!sidebarCollapsed">
                <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="logo-img">
                <span class="logo-text" x-text="settings.ui_settings.logo_text || 'JustChat'"></span>
            </div>
            <button class="btn-icon" @click="sidebarCollapsed = !sidebarCollapsed" :title="sidebarCollapsed ? t('expand') : t('collapse')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6" x-show="!sidebarCollapsed"></polyline>
                    <polyline points="9 18 15 12 9 6" x-show="sidebarCollapsed"></polyline>
                </svg>
            </button>
        </div>
        
        <button class="btn-new-chat" @click="createNewChat()" x-show="!sidebarCollapsed">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            <span x-text="t('newChat')"></span>
        </button>
        
        <button class="btn-new-chat-collapsed" @click="createNewChat()" x-show="sidebarCollapsed" :title="t('newChat')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
        </button>

        <div class="chat-list" x-show="!sidebarCollapsed">
            <template x-for="chat in chats" :key="chat.id">
                <div class="chat-item" :class="{ 'active': currentChatId === chat.id }" @click="selectChat(chat.id)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="chat-title" x-text="chat.title"></span>
                    <button class="btn-delete" @click.stop="deleteChat(chat.id)" :title="t('delete')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </template>
        </div>
        
        <button class="btn-clear-all" x-show="!sidebarCollapsed && chats.length > 0" @click="clearAllChats()" :title="t('clearAllChats')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span x-text="t('clearAllChats')"></span>
        </button>

        <div class="sidebar-footer" x-show="!sidebarCollapsed">
            <button class="btn-plugins" @click="showPlugins = true; loadPluginMarket()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
                <span x-text="t('plugins')"></span>
            </button>
            <button class="btn-settings" @click="showSettings = true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <span x-text="t('settings')"></span>
            </button>
        </div>
        
        <button class="btn-icon sidebar-plugins-collapsed" @click="showPlugins = true; loadPluginMarket()" x-show="sidebarCollapsed" :title="t('plugins')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
        </button>
        <button class="btn-icon sidebar-settings-collapsed" @click="showSettings = true" x-show="sidebarCollapsed" :title="t('settings')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header -->
        <div class="mobile-header" x-show="sidebarCollapsed">
            <button class="btn-icon" @click="sidebarCollapsed = false">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <span class="mobile-title">ChatRaw</span>
        </div>

        <div class="chat-container">
            <!-- Welcome -->
            <div class="welcome" x-show="messages.length === 0">
                <div class="welcome-logo">
                    <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="welcome-logo-img">
                </div>
                <h1 x-text="settings.ui_settings.logo_text || 'JustChat'"></h1>
                <p class="welcome-subtitle" x-text="settings.ui_settings.subtitle || t('defaultSubtitle')"></p>
                
                <div class="welcome-features">
                    <div class="feature">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <span x-text="t('fastResponse')"></span>
                    </div>
                    <div class="feature">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                        </svg>
                        <span x-text="t('pluginMarket')"></span>
                    </div>
                    <div class="feature">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                        <span x-text="t('multiModel')"></span>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="messages" x-ref="messagesContainer">
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="message" :class="msg.role">
                        <div class="message-avatar" :class="msg.role">
                            <!-- User avatar -->
                            <img x-show="msg.role === 'user' && settings.ui_settings.user_avatar" :src="settings.ui_settings.user_avatar" alt="User" style="width:100%; height:100%; object-fit:cover;">
                            <svg x-show="msg.role === 'user' && !settings.ui_settings.user_avatar" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <!-- AI avatar -->
                            <img x-show="msg.role === 'assistant' && settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" style="width:100%; height:100%; object-fit:cover;">
                            <span x-show="msg.role === 'assistant' && !settings.ui_settings.assistant_avatar">AI</span>
                        </div>
                        <div class="message-content">
                            <!-- Show typing indicator for empty assistant message while generating -->
                            <div class="typing-indicator" x-show="msg.role === 'assistant' && !msg.content && isGenerating">
                                <span></span><span></span><span></span>
                            </div>
                            <!-- Thinking/Reasoning Block -->
                            <div class="thinking-block" x-show="msg.thinking && msg.thinking.length > 0">
                                <div class="thinking-header" @click="msg.showThinking = !msg.showThinking">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/>
                                        <path d="M9 21h6"/>
                                    </svg>
                                    <span x-text="t('thinkingProcess')"></span>
                                    <svg class="chevron" :class="{ 'expanded': msg.showThinking }" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="thinking-content" x-show="msg.showThinking" x-collapse>
                                    <div x-html="renderMarkdown(msg.thinking)"></div>
                                </div>
                            </div>
                            
                            <!-- Show actual content -->
                            <div x-show="msg.content" x-html="renderMarkdown(msg.content)"></div>
                            
                            <!-- RAG References -->
                            <div class="rag-references" x-show="msg.references && msg.references.length > 0">
                                <div class="rag-references-header" @click="msg.showRefs = !msg.showRefs">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                    </svg>
                                    <span x-text="t('ragReferences') + ' (' + (msg.references?.length || 0) + ')'"></span>
                                    <svg class="chevron" :class="{ 'expanded': msg.showRefs }" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="rag-references-list" x-show="msg.showRefs" x-collapse>
                                    <template x-for="(ref, refIdx) in msg.references" :key="refIdx">
                                        <div class="rag-reference-item">
                                            <div class="ref-header">
                                                <span class="ref-badge" x-text="'#' + (refIdx + 1)"></span>
                                                <span class="ref-score" x-text="t('relevance') + ': ' + (ref.score * 100).toFixed(0) + '%'"></span>
                                            </div>
                                            <div class="ref-content" x-text="ref.content.length > 200 ? ref.content.substring(0, 200) + '...' : ref.content"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="message assistant" x-show="isGenerating && (!messages.length || messages[messages.length-1].role !== 'assistant')">
                    <div class="message-avatar assistant">
                        <img x-show="settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" style="width:100%; height:100%; object-fit:cover;">
                        <span x-show="!settings.ui_settings.assistant_avatar">AI</span>
                    </div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container-inner">
                    <div class="uploaded-image-preview" x-show="uploadedImage">
                        <img :src="uploadedImage ? 'data:image/jpeg;base64,' + uploadedImageBase64 : ''" alt="Preview">
                        <button class="btn-delete" @click="removeUploadedImage()" style="opacity:1; position:absolute; top:-10px; right:-10px; background:var(--error-color); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">×</button>
                    </div>
                    
                    <!-- Parsed URL Preview -->
                    <div class="parsed-url-preview" x-show="parsedUrl" x-cloak>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        <span class="parsed-url-title" x-text="parsedUrlTitle"></span>
                        <button class="btn-remove-url" @click="removeParsedUrl()">×</button>
                    </div>
                    
                    <!-- Attached Document Preview -->
                    <div class="attached-doc-preview" x-show="attachedDocument" x-cloak>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <span class="attached-doc-name" x-text="attachedDocument?.filename"></span>
                        <button class="btn-remove-doc" @click="removeAttachedDocument()">×</button>
                    </div>

                    <div class="input-wrapper">
                        <textarea 
                            x-model="inputMessage" 
                            @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); sendMessage() }"
                            :placeholder="t('inputPlaceholder')"
                            rows="1"
                            x-ref="inputBox"
                            @input="autoResize($refs.inputBox)"
                        ></textarea>
                        
                        <div class="input-toolbar">
                            <!-- Thinking Mode Toggle -->
                            <div class="thinking-toggle" :class="{ 'active': useThinking }" @click="useThinking = !useThinking" :title="t('thinkingMode')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/>
                                    <path d="M9 21h6"/>
                                    <path d="M10 24h4"/>
                                </svg>
                                <div class="thinking-slider">
                                    <div class="thinking-slider-handle"></div>
                                </div>
                            </div>
                            <label class="btn-tool" :title="t('uploadImage')" style="z-index: 10; position: relative;">
                                <input type="file" @change="handleImageUpload($event)" accept="image/*" style="display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </label>
                            <label class="btn-tool" :title="t('uploadDocument')" :class="{ 'active': attachedDocument }" style="z-index: 10; position: relative;">
                                <input type="file" @change="handleDocumentUpload($event)" accept=".pdf,.docx,.doc,.txt,.md" style="display: none;" :disabled="isUploadingDocument">
                                <svg x-show="!isUploadingDocument" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                <svg x-show="isUploadingDocument" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </label>
                            <button class="btn-tool" @click="toggleUrlInput()" :title="t('parseUrl')" :class="{ 'active': parsedUrl }">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                            </button>
                            
                            <!-- URL Input Popup -->
                            <div class="url-input-popup" x-show="showUrlInput" x-cloak @click.outside="cancelUrlInput()">
                                <div class="url-input-header" x-text="t('enterUrl')"></div>
                                <input 
                                    type="text" 
                                    x-model="urlInputValue" 
                                    :placeholder="t('urlPlaceholder')"
                                    @keydown.enter="parseUrl()"
                                    @keydown.escape="cancelUrlInput()"
                                    :disabled="isParsingUrl"
                                >
                                <div class="url-input-actions">
                                    <button class="btn-cancel" @click="cancelUrlInput()" x-text="t('cancel')"></button>
                                    <button class="btn-confirm" @click="parseUrl()" :disabled="isParsingUrl || !urlInputValue.trim()">
                                        <span x-show="!isParsingUrl" x-text="t('confirm')"></span>
                                        <span x-show="isParsingUrl" x-text="t('parsing')"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Send Button -->
                        <button class="btn-send" x-show="!isGenerating" @click="sendMessage()" :disabled="!inputMessage.trim()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                        <!-- Stop Button -->
                        <button class="btn-stop" x-show="isGenerating" @click="stopGeneration()" :title="t('stopGeneration')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12" rx="2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Settings Modal -->
    <div class="modal-overlay" x-show="showSettings" x-cloak @click.self="showSettings = false" x-transition>
        <div class="settings-modal">
            <!-- Left Nav -->
            <div class="settings-nav">
                <div class="settings-title" x-text="t('settings')"></div>
                <div class="nav-item" :class="{ 'active': settingsTab === 'models' }" @click="settingsTab = 'models'" x-text="t('modelConfig')"></div>
                <div class="nav-item" :class="{ 'active': settingsTab === 'chat' }" @click="settingsTab = 'chat'" x-text="t('chatSettings')"></div>
                <div class="nav-item" :class="{ 'active': settingsTab === 'ui' }" @click="settingsTab = 'ui'" x-text="t('uiSettings')"></div>
                <div class="settings-footer">
                    © 2026 ChatRaw by massif-01, RMinte AI Technology Co., Ltd.<br>
                    <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener" style="color: inherit; text-decoration: none; opacity: 0.7;" x-text="t('apacheLicense')"></a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="settings-content">
                <div class="settings-scroll-area">
                    
                    <!-- Models Tab -->
                    <div x-show="settingsTab === 'models'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('modelConfig')"></h2>
                            <p class="section-desc" x-text="t('modelConfigDesc')"></p>
                        </div>
                        
                        <template x-for="(model, index) in models" :key="model.id || index">
                            <div class="model-card" x-show="model.type === 'chat'">
                                <div class="model-header">
                                    <span class="model-badge" x-text="getModelTypeName(model.type)"></span>
                                    <div class="model-status" :class="model.status || 'unknown'">
                                        <span x-show="model.status === 'success'" style="color:var(--success-color)" x-text="'● ' + t('active')"></span>
                                        <span x-show="model.status === 'error'" style="color:var(--error-color)" x-text="'● ' + t('error')"></span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">API Endpoint</label>
                                    <input type="text" class="input-minimal" x-model="model.api_url">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">API Key (Optional)</label>
                                    <input type="password" class="input-minimal" x-model="model.api_key">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Model ID</label>
                                    <input type="text" class="input-minimal" x-model="model.model_id">
                                </div>

                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('capabilities')"></label>
                                    <div class="checkbox-group" style="display:flex; gap:20px; margin-top:8px;">
                                        <label style="display:flex; align-items:center; gap:8px; font-size:0.95rem; cursor:pointer;">
                                            <input type="checkbox" x-model="model.capability.vision" style="width:16px; height:16px;"> <span x-text="t('vision')"></span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; font-size:0.95rem; cursor:pointer;">
                                            <input type="checkbox" x-model="model.capability.reasoning" style="width:16px; height:16px;"> <span x-text="t('reasoning')"></span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; font-size:0.95rem; cursor:pointer;">
                                            <input type="checkbox" x-model="model.capability.tools" style="width:16px; height:16px;"> <span x-text="t('tools')"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('contextLength')"></label>
                                    <input type="number" class="input-minimal" x-model.number="model.context_length" placeholder="8192">
                                </div>

                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('maxOutput')"></label>
                                    <input type="number" class="input-minimal" x-model.number="model.max_output" placeholder="4096">
                                </div>

                                <button class="btn-primary" style="width:100%" @click="saveAndVerifyModel(model, index)" :disabled="model.status === 'loading'">
                                    <span x-text="model.status === 'loading' ? t('verifying') : t('saveAndVerify')"></span>
                                </button>
                                <div x-show="model.verifyMessage" style="margin-top:10px; font-size:0.85rem;" :style="{ color: model.status === 'success' ? 'var(--success-color)' : 'var(--error-color)' }" x-text="model.verifyMessage"></div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Chat Settings Tab -->
                    <div x-show="settingsTab === 'chat'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('chatSettings')"></h2>
                            <p class="section-desc" x-text="t('chatSettingsDesc')"></p>
                        </div>

                        <div class="form-group">
                            <div class="toggle-row">
                                <div class="toggle-info">
                                    <label class="form-label" x-text="t('streamOutput')"></label>
                                    <span class="form-sublabel" x-text="t('streamHint')"></span>
                                </div>
                                <div class="toggle-switch" :class="{ 'checked': settings.chat_settings.stream }" @click="settings.chat_settings.stream = !settings.chat_settings.stream">
                                    <div class="toggle-handle"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Temperature: <span x-text="settings.chat_settings.temperature"></span></label>
                            <input type="range" min="0" max="2" step="0.1" x-model.number="settings.chat_settings.temperature">
                            <span class="form-sublabel" style="margin-top:8px;" x-text="t('temperatureHint')"></span>
                        </div>

                        <!-- Top P Slider Restored -->
                        <div class="form-group">
                            <label class="form-label">Top P: <span x-text="settings.chat_settings.top_p"></span></label>
                            <input type="range" min="0" max="1" step="0.05" x-model.number="settings.chat_settings.top_p">
                            <span class="form-sublabel" style="margin-top:8px;" x-text="t('topPHint')"></span>
                        </div>

                        <!-- System Prompt -->
                        <div class="form-group">
                            <label class="form-label" x-text="t('systemPrompt')"></label>
                            <span class="form-sublabel" style="margin-bottom:12px; display:block;" x-text="t('systemPromptHint')"></span>
                            <textarea 
                                class="system-prompt-textarea" 
                                x-model="settings.chat_settings.system_prompt"
                                :placeholder="t('systemPromptPlaceholder')"
                                rows="4"
                            ></textarea>
                        </div>
                    </div>

                    <!-- UI Settings Tab -->
                    <div x-show="settingsTab === 'ui'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('uiSettings')"></h2>
                            <p class="section-desc" x-text="t('uiSettingsDesc')"></p>
                        </div>

                        <div class="form-group" style="margin-bottom: 40px;">
                            <label class="form-label" x-text="t('theme')"></label>
                            <div class="theme-grid">
                                <div class="theme-option" :class="{ 'active': settings.ui_settings.theme_mode === 'light' }" @click="settings.ui_settings.theme_mode = 'light'; applyTheme()">
                                    Light
                                </div>
                                <div class="theme-option" :class="{ 'active': settings.ui_settings.theme_mode === 'dark' }" @click="settings.ui_settings.theme_mode = 'dark'; applyTheme()">
                                    Dark
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 40px;">
                            <label class="form-label" x-text="t('language')"></label>
                            <div class="theme-grid">
                                <div class="theme-option" :class="{ 'active': lang === 'en' }" @click="setLanguage('en')">English</div>
                                <div class="theme-option" :class="{ 'active': lang === 'zh' }" @click="setLanguage('zh')">中文</div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 40px;">
                            <label class="form-label" x-text="t('logoName')"></label>
                            <div class="logo-upload-area" style="display:flex; align-items:center; gap:12px; flex-wrap:nowrap;">
                                <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="logo-preview" style="width:48px; height:48px; min-width:48px; border-radius:var(--radius-sm); object-fit:cover; border:1px solid var(--border-color); flex-shrink:0;">
                                <label class="btn-secondary" style="margin:0; white-space:nowrap; flex-shrink:0;">
                                    <input type="file" @change="handleLogoUpload($event)" accept="image/*" style="display: none;">
                                    <span x-text="t('uploadLogo')"></span>
                                </label>
                                <button class="btn-delete" x-show="settings.ui_settings.logo_data" @click="settings.ui_settings.logo_data = ''" style="opacity:1; width:32px; height:32px; border:1px solid var(--border-color); flex-shrink:0;">×</button>
                                <input type="text" x-model="settings.ui_settings.logo_text" placeholder="JustChat" class="input-minimal" style="flex:1; min-width:0;">
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 40px;">
                            <label class="form-label" x-text="t('subtitle')"></label>
                            <input type="text" x-model="settings.ui_settings.subtitle" :placeholder="t('defaultSubtitle')" class="input-minimal">
                        </div>

                        <div class="form-group" style="margin-bottom: 40px;">
                            <label class="form-label" x-text="t('avatars')"></label>
                            
                            <!-- Avatars Row -->
                            <div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap;">
                                <!-- User Avatar -->
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <div class="avatar-preview" style="width:40px; height:40px; border-radius:50%; background:var(--bg-tertiary); overflow:hidden; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                        <img x-show="settings.ui_settings.user_avatar" :src="settings.ui_settings.user_avatar" alt="User" style="width:100%; height:100%; object-fit:cover;">
                                        <svg x-show="!settings.ui_settings.user_avatar" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    </div>
                                    <label class="btn-secondary" style="margin:0;">
                                        <input type="file" @change="handleAvatarUpload($event, 'user')" accept="image/*" style="display: none;">
                                        <span x-text="t('uploadUserAvatar')"></span>
                                    </label>
                                </div>

                                <!-- AI Avatar -->
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <div class="avatar-preview" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-primary); overflow:hidden; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                        <img x-show="settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" style="width:100%; height:100%; object-fit:cover;">
                                        <span x-show="!settings.ui_settings.assistant_avatar" style="font-weight:bold; font-size:14px;">AI</span>
                                    </div>
                                    <label class="btn-secondary" style="margin:0;">
                                        <input type="file" @change="handleAvatarUpload($event, 'assistant')" accept="image/*" style="display: none;">
                                        <span x-text="t('uploadAIAvatar')"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Modal Actions Footer -->
                <div class="modal-actions-bar">
                    <button class="btn-secondary" @click="showSettings = false" x-text="t('cancel')"></button>
                    <button class="btn-primary" @click="saveAllSettings()" x-text="t('save')"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin Modal -->
    <div class="modal-overlay" x-show="showPlugins" x-cloak @click.self="showPlugins = false" x-transition>
        <div class="settings-modal plugin-modal">
            <!-- Left Nav -->
            <div class="settings-nav">
                <div class="settings-title" x-text="t('plugins')"></div>
                <div class="nav-item" :class="{ 'active': pluginTab === 'market' }" @click="pluginTab = 'market'; loadPluginMarket()" x-text="t('pluginMarket')"></div>
                <div class="nav-item" :class="{ 'active': pluginTab === 'installed' }" @click="pluginTab = 'installed'" x-text="t('installedPlugins')"></div>
                <div class="nav-item" :class="{ 'active': pluginTab === 'local' }" @click="pluginTab = 'local'" x-text="t('installLocalPlugin')"></div>
                <div class="settings-footer">
                    © 2026 ChatRaw by massif-01, RMinte AI Technology Co., Ltd.<br>
                    <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener" style="color: inherit; text-decoration: none; opacity: 0.7;" x-text="t('apacheLicense')"></a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="settings-content">
                <div class="settings-scroll-area">
                    
                    <!-- Plugin Market Tab -->
                    <div x-show="pluginTab === 'market'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('pluginMarket')"></h2>
                            <p class="section-desc" x-text="t('pluginMarketDesc')"></p>
                        </div>
                        
                        <!-- Loading -->
                        <div class="plugin-loading" x-show="pluginMarketLoading">
                            <div class="spinner"></div>
                            <span x-text="t('refreshingMarket')"></span>
                        </div>
                        
                        <!-- Error -->
                        <div class="plugin-error" x-show="pluginMarketError && !pluginMarketLoading">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span x-text="t('networkError')"></span>
                            <button class="btn-secondary" @click="loadPluginMarket()" x-text="t('retry')"></button>
                        </div>
                        
                        <!-- Plugin Grid -->
                        <div class="plugin-grid" x-show="!pluginMarketLoading && !pluginMarketError">
                            <template x-for="plugin in marketPlugins" :key="plugin.id">
                                <div class="plugin-card">
                                    <img :src="'https://raw.githubusercontent.com/massif-01/ChatRaw/main/Plugins/Plugin_market/' + plugin.folder + '/icon.png'" 
                                         class="plugin-icon" 
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect fill=%22%23666%22 width=%2224%22 height=%2224%22 rx=%224%22/></svg>'">
                                    <div class="plugin-info">
                                        <div class="plugin-name" x-text="plugin.name[lang] || plugin.name.en"></div>
                                        <div class="plugin-version" x-text="'v' + plugin.version"></div>
                                        <div class="plugin-desc" x-text="plugin.description[lang] || plugin.description.en"></div>
                                    </div>
                                    <div class="plugin-actions">
                                        <button class="btn-primary btn-sm" 
                                                @click="installPlugin(plugin)" 
                                                :disabled="isPluginInstalled(plugin.id) || pluginInstalling === plugin.id"
                                                x-text="pluginInstalling === plugin.id ? t('installing') : (isPluginInstalled(plugin.id) ? t('installed') : t('install'))">
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="marketPlugins.length === 0" class="plugin-empty" x-text="t('noPluginsAvailable')"></div>
                        </div>
                    </div>
                    
                    <!-- Installed Plugins Tab -->
                    <div x-show="pluginTab === 'installed'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('installedPlugins')"></h2>
                            <p class="section-desc" x-text="t('installedPluginsDesc')"></p>
                        </div>
                        
                        <div class="plugin-list" x-show="installedPlugins.length > 0">
                            <template x-for="plugin in installedPlugins" :key="plugin.id">
                                <div class="plugin-card installed">
                                    <img :src="'/api/plugins/' + encodeURIComponent(plugin.id) + '/icon'" 
                                         class="plugin-icon"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect fill=%22%23666%22 width=%2224%22 height=%2224%22 rx=%224%22/></svg>'">
                                    <div class="plugin-info">
                                        <div class="plugin-name" x-text="plugin.name?.[lang] || plugin.name?.en || plugin.name || plugin.id"></div>
                                        <div class="plugin-version" x-text="'v' + (plugin.version || '1.0.0')"></div>
                                        <div class="plugin-desc" x-text="plugin.description?.[lang] || plugin.description?.en || ''"></div>
                                    </div>
                                    <div class="plugin-actions">
                                        <button class="btn-icon" @click="openPluginSettings(plugin)" :title="t('settings')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon btn-icon-danger" @click="uninstallPlugin(plugin)" :title="t('uninstall')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                <line x1="10" y1="11" x2="10" y2="17"/>
                                                <line x1="14" y1="11" x2="14" y2="17"/>
                                            </svg>
                                        </button>
                                        <div class="toggle-switch" :class="{ 'checked': plugin.enabled }" @click="togglePlugin(plugin)">
                                            <div class="toggle-handle"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="installedPlugins.length === 0" class="plugin-empty" x-text="t('noPluginsInstalled')"></div>
                    </div>
                    
                    <!-- Install Local Plugin Tab -->
                    <div x-show="pluginTab === 'local'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('installLocalPlugin')"></h2>
                            <p class="section-desc" x-text="t('installLocalPluginDesc')"></p>
                        </div>
                        
                        <div class="upload-area plugin-upload" @click="$refs.pluginFileInput.click()">
                            <input type="file" x-ref="pluginFileInput" @change="handlePluginUpload($event)" accept=".zip" style="display: none;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <div x-text="t('selectPluginZip')"></div>
                        </div>
                        
                        <!-- Upload progress -->
                        <div class="plugin-upload-progress" x-show="pluginUploading">
                            <div class="spinner"></div>
                            <span x-text="t('installing')"></span>
                        </div>
                        
                        <div class="plugin-dev-guide">
                            <a href="https://github.com/massif-01/ChatRaw/blob/main/Plugins/README.md" target="_blank" rel="noopener">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                <span x-text="t('pluginDevGuide')"></span>
                            </a>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Modal Actions Footer -->
                <div class="modal-actions-bar">
                    <button class="btn-secondary" @click="showPlugins = false" x-text="t('close')"></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Plugin Settings Modal -->
    <div class="modal-overlay" x-show="showPluginSettings" x-cloak @click.self="showPluginSettings = false" x-transition>
        <div class="plugin-settings-modal" :class="{ 'custom-settings-modal': currentPluginSettings?.customSettings }">
            <div class="plugin-settings-header" x-show="!currentPluginSettings?.customSettings">
                <h3 x-text="currentPluginSettings?.name?.[lang] || currentPluginSettings?.name?.en || currentPluginSettings?.id || ''"></h3>
            </div>
            <div class="plugin-settings-content" :class="{ 'custom-settings-content': currentPluginSettings?.customSettings }">
                <!-- Custom Settings Container (for plugins with customSettings: true) -->
                <template x-if="currentPluginSettings?.customSettings">
                    <div id="plugin-custom-settings-area" class="plugin-custom-settings">
                        <div style="padding:20px; text-align:center; color:var(--text-muted);">Loading...</div>
                    </div>
                </template>
                
                <!-- Standard Settings (only when no customSettings) -->
                <template x-if="!currentPluginSettings?.customSettings && currentPluginSettings?.settings?.length > 0">
                    <div>
                        <template x-for="setting in currentPluginSettings.settings" :key="setting.id">
                            <div class="form-group">
                                <label class="form-label" x-text="setting.label?.[lang] || setting.label?.en || setting.id"></label>
                                
                                <!-- Boolean -->
                                <template x-if="setting.type === 'boolean'">
                                    <div class="toggle-switch" :class="{ 'checked': pluginSettingsValues[setting.id] }" 
                                         @click="pluginSettingsValues[setting.id] = !pluginSettingsValues[setting.id]">
                                        <div class="toggle-handle"></div>
                                    </div>
                                </template>
                                
                                <!-- String -->
                                <template x-if="setting.type === 'string'">
                                    <input type="text" class="input-minimal" 
                                           x-model="pluginSettingsValues[setting.id]" 
                                           :placeholder="String(setting.default || '')">
                                </template>
                                
                                <!-- Number -->
                                <template x-if="setting.type === 'number'">
                                    <input type="number" class="input-minimal" 
                                           x-model.number="pluginSettingsValues[setting.id]"
                                           :min="setting.min" :max="setting.max"
                                           :placeholder="String(setting.default || '')">
                                </template>
                                
                                <!-- Select -->
                                <template x-if="setting.type === 'select'">
                                    <select class="input-minimal" x-model="pluginSettingsValues[setting.id]">
                                        <template x-for="opt in (setting.options || [])" :key="opt">
                                            <option :value="opt" x-text="opt"></option>
                                        </template>
                                    </select>
                                </template>
                                
                                <!-- Password -->
                                <template x-if="setting.type === 'password'">
                                    <input type="password" class="input-minimal" 
                                           x-model="pluginSettingsValues[setting.id]"
                                           placeholder="••••••••">
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- No Settings (only when no customSettings AND no standard settings) -->
                <template x-if="!currentPluginSettings?.customSettings && (!currentPluginSettings?.settings || currentPluginSettings.settings.length === 0)">
                    <div class="plugin-no-settings" x-text="t('noPluginSettings')"></div>
                </template>
                
                <!-- Proxy/API Key settings (only for non-custom settings plugins) -->
                <template x-if="!currentPluginSettings?.customSettings && currentPluginSettings && currentPluginSettings.proxy && currentPluginSettings.proxy.length > 0">
                    <div class="plugin-proxy-settings">
                        <h4 x-text="t('apiKeySettings')"></h4>
                        <template x-for="proxy in currentPluginSettings.proxy" :key="proxy.id">
                            <div class="form-group">
                                <label class="form-label" x-text="proxy.name?.[lang] || proxy.name?.en || proxy.id"></label>
                                <p class="form-sublabel" x-text="proxy.description?.[lang] || proxy.description?.en || ''"></p>
                                <input type="text" class="input-minimal" 
                                       x-model="pluginApiKeys[proxy.id]"
                                       :placeholder="pluginApiKeys[proxy.id] ? '' : t('enterApiKey')"
                                       @focus="if(pluginApiKeys[proxy.id]?.includes('*')) pluginApiKeys[proxy.id] = ''">
                                <p class="form-hint" x-show="pluginApiKeys[proxy.id]?.includes('*')" x-text="t('apiKeySet')"></p>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div class="plugin-settings-footer" x-show="!currentPluginSettings?.customSettings">
                <button class="btn-secondary" @click="showPluginSettings = false" x-text="t('cancel')"></button>
                <button class="btn-primary" @click="savePluginSettings()" x-text="t('save')"></button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" x-show="toast.show" x-text="toast.message" :class="toast.type" x-transition></div>

    <script src="app.js?v=5.0"></script>
</body>
</html>