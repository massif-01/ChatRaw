<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="ChatRaw - A minimalist, fast, and powerful AI chat interface with multi-model support, plugin marketplace, and advanced features like RAG and thinking mode.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ChatRaw</title>
    <link rel="icon" id="favicon" href="data:,">
    
    <!-- Performance: DNS Prefetch & Preconnect for CDN -->
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin="anonymous">
    
    <!-- Performance: Preload Critical Resources -->
    <link rel="preload" href="fonts/remixicon/remixicon.woff2?t=1769685282643" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="styles.min.css?v=6.0" as="style">
    <link rel="preload" href="app.min.js?v=6.0" as="script">
    <link rel="preload" href="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://unpkg.com/marked@9.1.6/marked.min.js" as="script" crossorigin="anonymous">
    
    <!-- Critical CSS: Inline for faster first paint -->
    <style>
        /* RemixIcon - Inline to avoid render blocking */
        @font-face{font-family:"remixicon";src:url('fonts/remixicon/remixicon.woff2?t=1769685282643') format("woff2"),url('fonts/remixicon/remixicon.woff?t=1769685282643') format("woff");font-display:optional}
        [class^="ri-"],[class*=" ri-"]{font-family:'remixicon'!important;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        .ri-add-line:before{content:"\ea13"}.ri-arrow-down-s-line:before{content:"\ea4e"}.ri-arrow-left-s-line:before{content:"\ea64"}.ri-arrow-right-s-line:before{content:"\ea6e"}.ri-close-circle-fill:before{content:"\eb96"}.ri-close-line:before{content:"\eb99"}.ri-computer-line:before{content:"\ebca"}.ri-delete-bin-line:before{content:"\ec2a"}.ri-error-warning-line:before{content:"\eca1"}.ri-external-link-line:before{content:"\ecaf"}.ri-file-text-line:before{content:"\ed0f"}.ri-flashlight-line:before{content:"\ed3d"}.ri-image-line:before{content:"\ee4b"}.ri-lightbulb-line:before{content:"\eea9"}.ri-link:before{content:"\eeb2"}.ri-loader-4-line:before{content:"\eec6"}.ri-menu-line:before{content:"\ef3e"}.ri-message-3-line:before{content:"\ef46"}.ri-robot-2-line:before{content:"\f3d8"}.ri-send-plane-2-line:before{content:"\f0d8"}.ri-settings-3-line:before{content:"\f0e6"}.ri-stop-circle-line:before{content:"\f19f"}.ri-tools-line:before{content:"\f21b"}.ri-upload-2-line:before{content:"\f24a"}.ri-user-3-line:before{content:"\f256"}.ri-file-copy-line:before{content:"\ecd5"}.ri-check-line:before{content:"\eb7b"}
        
        :root {
            --background: 0 0% 100%;
            --foreground: 0 0% 0%;
            --muted: 0 0% 94.1%;
            --muted-foreground: 0 0% 40%;
            --accent: 0 0% 95.3%;
            --border: 0 0% 89.8%;
            --ring: 0 0% 0%;
            --destructive: 0 84.2% 60.2%;
            --success: 142.1 76.2% 36.3%;
            --bg-primary: hsl(var(--background));
            --bg-secondary: #f9f9f9;
            --bg-tertiary: hsl(var(--muted));
            --bg-hover: hsl(var(--accent));
            --text-primary: hsl(var(--foreground));
            --text-secondary: hsl(var(--muted-foreground));
            --text-muted: #6b6b6b;
            --border-color: hsl(var(--border));
            --border-focus: hsl(var(--foreground));
            --accent-color: hsl(var(--foreground));
            --on-accent: hsl(var(--background));
            --success-color: hsl(var(--success));
            --error-color: hsl(var(--destructive));
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
            --font-mono: ui-monospace, 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
            --duration-normal: 200ms;
            --transition: all var(--duration-normal) var(--ease);
        }
        [data-theme="dark"] {
            --background: 0 0% 0%;
            --foreground: 0 0% 100%;
            --muted: 0 0% 8.6%;
            --muted-foreground: 0 0% 62.7%;
            --accent: 0 0% 10.2%;
            --border: 0 0% 15.7%;
            --bg-secondary: #0a0a0a;
            --text-muted: #737373;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; height: 100dvh; overflow: hidden; }
        body {
            height: 100%; height: -webkit-fill-available; height: 100dvh;
            overflow: hidden;
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }
        [x-cloak] { display: none !important; }
        .sidebar {
            width: 280px;
            min-width: 280px;
            height: 100%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10;
            flex-shrink: 0;
        }
        .sidebar.collapsed { width: 72px; min-width: 72px; }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }
        .welcome h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 40px;
        }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); }
        }
    </style>
    
    <!-- External Scripts -->
    <script src="https://unpkg.com/marked@9.1.6/marked.min.js" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.13.3/dist/cdn.min.js" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" crossorigin="anonymous"></script>
    <!-- highlight.js is lazy-loaded in app.min.js when needed -->
    <link rel="stylesheet" href="fonts/remixicon/remixicon.css">
    <link rel="stylesheet" href="styles.min.css?v=6.0">
</head>
<body x-data="app()" x-init="init()" :data-theme="settings.ui_settings.theme_mode">
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" x-show="!sidebarCollapsed" @click="sidebarCollapsed = true" x-transition:enter="fade-enter" x-transition:leave="fade-leave"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" :class="{ 'collapsed': sidebarCollapsed }">
        <div class="sidebar-header">
            <div class="logo" x-show="!sidebarCollapsed">
                <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="logo-img" width="32" height="32">
                <span class="logo-text" x-text="settings.ui_settings.logo_text || 'JustChat'"></span>
            </div>
            <button class="btn-icon" @click="sidebarCollapsed = !sidebarCollapsed" :title="sidebarCollapsed ? t('expand') : t('collapse')" :aria-expanded="String(!sidebarCollapsed)" aria-label="Toggle sidebar">
                <i class="ri-arrow-left-s-line" x-show="!sidebarCollapsed"></i>
                <i class="ri-arrow-right-s-line" x-show="sidebarCollapsed"></i>
            </button>
        </div>
        
        <button class="btn-new-chat" @click="createNewChat()" x-show="!sidebarCollapsed">
            <i class="ri-add-line"></i>
            <span x-text="t('newChat')"></span>
        </button>
        
        <button class="btn-new-chat-collapsed" @click="createNewChat()" x-show="sidebarCollapsed" :title="t('newChat')" :aria-label="t('newChat')">
            <i class="ri-add-line"></i>
        </button>

        <div class="chat-list" x-show="!sidebarCollapsed">
            <template x-for="chat in chats" :key="chat.id">
                <div class="chat-item" :class="{ 'active': currentChatId === chat.id }" @click="selectChat(chat.id)">
                    <i class="ri-message-3-line"></i>
                    <span class="chat-title" x-text="chat.title"></span>
                    <button class="btn-delete" @click.stop="deleteChat(chat.id)" :title="t('delete')">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            </template>
        </div>
        
        <button class="btn-clear-all" x-show="!sidebarCollapsed && chats.length > 0" @click="clearAllChats()" :title="t('clearAllChats')">
            <i class="ri-delete-bin-line"></i>
            <span x-text="t('clearAllChats')"></span>
        </button>

        <div class="sidebar-footer" x-show="!sidebarCollapsed">
            <button class="btn-plugins" @click="showPlugins = true; loadPluginMarket()">
                <i class="ri-tools-line"></i>
                <span x-text="t('plugins')"></span>
            </button>
            <button class="btn-settings" @click="showSettings = true">
                <i class="ri-settings-3-line"></i>
                <span x-text="t('settings')"></span>
            </button>
        </div>
        
        <button class="btn-icon sidebar-plugins-collapsed" @click="showPlugins = true; loadPluginMarket()" x-show="sidebarCollapsed" :title="t('plugins')">
            <i class="ri-tools-line"></i>
        </button>
        <button class="btn-icon sidebar-settings-collapsed" @click="showSettings = true" x-show="sidebarCollapsed" :title="t('settings')">
            <i class="ri-settings-3-line"></i>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header -->
        <div class="mobile-header" x-show="sidebarCollapsed">
            <button class="btn-icon" @click="sidebarCollapsed = false">
                <i class="ri-menu-line"></i>
            </button>
            <span class="mobile-title">ChatRaw</span>
        </div>

        <div class="chat-container">
            <!-- Welcome - Pre-rendered for LCP optimization -->
            <div class="welcome" x-show="messages.length === 0">
                <div class="welcome-logo">
                    <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="welcome-logo-img" width="80" height="80">
                </div>
                <h1 x-text="settings.ui_settings.logo_text || 'ChatRaw'">ChatRaw</h1>
                <p class="welcome-subtitle" x-text="settings.ui_settings.subtitle || t('defaultSubtitle')">Your minimalist AI assistant</p>
                
                <div class="welcome-features">
                    <div class="feature">
                        <i class="ri-flashlight-line"></i>
                        <span x-text="t('fastResponse')">Fast Response</span>
                    </div>
                    <div class="feature">
                        <i class="ri-tools-line"></i>
                        <span x-text="t('pluginMarket')">Plugin Market</span>
                    </div>
                    <div class="feature">
                        <i class="ri-computer-line"></i>
                        <span x-text="t('multiModel')">Multi-Model</span>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="messages" x-ref="messagesContainer" aria-live="polite">
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="message" :class="msg.role">
                        <div class="message-avatar" :class="msg.role">
                            <!-- User avatar -->
                            <img x-show="msg.role === 'user' && settings.ui_settings.user_avatar" :src="settings.ui_settings.user_avatar" alt="User" width="36" height="36" class="avatar-img">
                            <i class="ri-user-3-line" x-show="msg.role === 'user' && !settings.ui_settings.user_avatar"></i>
                            <!-- AI avatar -->
                            <img x-show="msg.role === 'assistant' && settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" width="36" height="36" class="avatar-img">
                            <i class="ri-robot-2-line" x-show="msg.role === 'assistant' && !settings.ui_settings.assistant_avatar"></i>
                        </div>
                        <div class="message-content">
                            <!-- Show typing indicator for empty assistant message while generating -->
                            <div class="typing-indicator" x-show="msg.role === 'assistant' && !msg.content && isGenerating">
                                <span></span><span></span><span></span>
                            </div>
                            <!-- Thinking/Reasoning Block -->
                            <div class="thinking-block" x-show="msg.thinking && msg.thinking.length > 0">
                                <div class="thinking-header" @click="msg.showThinking = !msg.showThinking" role="button" :aria-expanded="msg.showThinking">
                                    <i class="ri-lightbulb-line"></i>
                                    <span x-text="t('thinkingProcess')"></span>
                                    <i class="ri-arrow-down-s-line chevron" :class="{ 'expanded': msg.showThinking }"></i>
                                </div>
                                <div class="thinking-content" x-show="msg.showThinking" x-collapse>
                                    <div x-html="renderMarkdown(msg.thinking)"></div>
                                </div>
                            </div>
                            
                            <!-- Show actual content -->
                            <div x-show="msg.content" x-html="renderMarkdown(msg.content)"></div>
                            
                            <!-- Message Actions (assistant only) -->
                            <div class="message-actions" x-show="msg.role === 'assistant' && msg.content && !isGenerating">
                                <button class="btn-copy"
                                        @click="copyMessage(msg.content, $event)"
                                        :title="t('copyMessage')">
                                    <i class="ri-file-copy-line"></i>
                                </button>
                            </div>
                            
                            <!-- RAG References -->
                            <div class="rag-references" x-show="msg.references && msg.references.length > 0">
                                <div class="rag-references-header" @click="msg.showRefs = !msg.showRefs" role="button" :aria-expanded="msg.showRefs">
                                    <i class="ri-file-text-line"></i>
                                    <span x-text="t('ragReferences') + ' (' + (msg.references?.length || 0) + ')'"></span>
                                    <i class="ri-arrow-down-s-line chevron" :class="{ 'expanded': msg.showRefs }"></i>
                                </div>
                                <div class="rag-references-list" x-show="msg.showRefs" x-collapse>
                                    <template x-for="(ref, refIdx) in msg.references" :key="refIdx">
                                        <div class="rag-reference-item">
                                            <div class="ref-header">
                                                <span class="ref-badge" x-text="'#' + (refIdx + 1)"></span>
                                                <span class="ref-score" x-text="t('relevance') + ': ' + (ref.score * 100).toFixed(0) + '%'"></span>
                                            </div>
                                            <div class="ref-content" x-text="ref.content.length > 200 ? ref.content.substring(0, 200) + '...' : ref.content"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="message assistant" x-show="isGenerating && (!messages.length || messages[messages.length-1].role !== 'assistant')">
                    <div class="message-avatar assistant">
                        <img x-show="settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" width="36" height="36" class="avatar-img">
                        <i class="ri-robot-2-line" x-show="!settings.ui_settings.assistant_avatar"></i>
                    </div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container-inner">
                    <div class="uploaded-image-preview" x-show="uploadedImage">
                        <img :src="uploadedImage ? 'data:image/jpeg;base64,' + uploadedImageBase64 : ''" alt="Preview" width="60" height="60">
                        <button class="btn-delete-overlay" @click="removeUploadedImage()" aria-label="Remove image"><i class="ri-close-circle-fill"></i></button>
                    </div>
                    
                    <!-- Parsed URL Preview -->
                    <div class="parsed-url-preview" x-show="parsedUrl" x-cloak>
                        <i class="ri-link"></i>
                        <span class="parsed-url-title" x-text="parsedUrlTitle"></span>
                        <button class="btn-remove-url" @click="removeParsedUrl()" aria-label="Remove URL"><i class="ri-close-circle-fill"></i></button>
                    </div>
                    
                    <!-- Attached Document Preview -->
                    <div class="attached-doc-preview" x-show="attachedDocument" x-cloak>
                        <i class="ri-file-text-line"></i>
                        <span class="attached-doc-name" x-text="attachedDocument?.filename"></span>
                        <button class="btn-remove-doc" @click="removeAttachedDocument()" aria-label="Remove document"><i class="ri-close-circle-fill"></i></button>
                    </div>

                    <div class="input-wrapper">
                        <textarea 
                            x-model="inputMessage" 
                            @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); sendMessage() }"
                            :placeholder="t('inputPlaceholder')"
                            rows="1"
                            x-ref="inputBox"
                            @input="autoResize($refs.inputBox)"
                        ></textarea>
                        
                        <div class="input-toolbar">
                            <!-- Thinking Mode Toggle -->
                            <div class="thinking-toggle" :class="{ 'active': useThinking }" @click="useThinking = !useThinking" :title="t('thinkingMode')">
                                <i class="ri-lightbulb-line"></i>
                                <div class="thinking-slider">
                                    <div class="thinking-slider-handle"></div>
                                </div>
                            </div>
                            <label class="btn-tool btn-tool-upload" :title="t('uploadImage')">
                                <input type="file" @change="handleImageUpload($event)" accept="image/*" class="file-input-hidden">
                                <i class="ri-image-line"></i>
                            </label>
                            <label class="btn-tool btn-tool-upload" :title="t('uploadDocument')" :class="{ 'active': attachedDocument }">
                                <input type="file" @change="handleDocumentUpload($event)" :accept="getDocumentAcceptTypes()" class="file-input-hidden" :disabled="isUploadingDocument">
                                <i class="ri-file-text-line" x-show="!isUploadingDocument"></i>
                                <i class="ri-loader-4-line spin" x-show="isUploadingDocument"></i>
                            </label>
                            <button class="btn-tool" @click="toggleUrlInput()" :title="t('parseUrl')" :class="{ 'active': parsedUrl }">
                                <i class="ri-link"></i>
                            </button>
                            
                            <!-- Plugin Toolbar Buttons Extension Area -->
                            <div class="plugin-toolbar-area" x-show="pluginToolbarButtons.length > 0" x-cloak>
                                <div class="plugin-toolbar-divider"></div>
                                
                                <!-- Visible buttons (max 5) -->
                                <template x-for="btn in visiblePluginButtons" :key="btn.fullId">
                                    <button 
                                        class="btn-tool plugin-btn" 
                                        :class="{ 'active': btn.active, 'loading': btn.loading }"
                                        :title="getPluginButtonLabel(btn)"
                                        @click="handlePluginButtonClick(btn)"
                                        :disabled="btn.loading">
                                        <i :class="btn.loading ? 'ri-loader-4-line spin' : btn.icon"></i>
                                    </button>
                                </template>
                                
                                <!-- More menu (shown when > 5 buttons) -->
                                <div class="plugin-more-dropdown" x-show="hiddenPluginButtons.length > 0" x-cloak>
                                    <button class="btn-tool" @click="showPluginMoreMenu = !showPluginMoreMenu" :title="t('plugins')">
                                        <i class="ri-more-2-fill"></i>
                                    </button>
                                    <div class="plugin-more-menu" 
                                         x-show="showPluginMoreMenu" 
                                         x-cloak
                                         x-transition
                                         @click.outside="showPluginMoreMenu = false">
                                        <template x-for="btn in hiddenPluginButtons" :key="btn.fullId">
                                            <div class="plugin-more-item" 
                                                 :class="{ 'active': btn.active, 'loading': btn.loading }"
                                                 @click="handlePluginButtonClick(btn); showPluginMoreMenu = false">
                                                <i :class="btn.loading ? 'ri-loader-4-line spin' : btn.icon"></i>
                                                <span x-text="getPluginButtonLabel(btn)"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- URL Input Popup -->
                            <div class="url-input-popup" x-show="showUrlInput" x-cloak @click.outside="cancelUrlInput()">
                                <div class="url-input-header" x-text="t('enterUrl')"></div>
                                <input 
                                    type="text" 
                                    x-model="urlInputValue" 
                                    :placeholder="t('urlPlaceholder')"
                                    @keydown.enter="parseUrl()"
                                    @keydown.escape="cancelUrlInput()"
                                    :disabled="isParsingUrl"
                                >
                                <div class="url-input-actions">
                                    <button class="btn-cancel" @click="cancelUrlInput()" x-text="t('cancel')"></button>
                                    <button class="btn-confirm" @click="parseUrl()" :disabled="isParsingUrl || !urlInputValue.trim()">
                                        <span x-show="!isParsingUrl" x-text="t('confirm')"></span>
                                        <span x-show="isParsingUrl" x-text="t('parsing')"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Send Button -->
                        <button class="btn-send" x-show="!isGenerating" @click="sendMessage()" :disabled="!inputMessage.trim()" :aria-label="t('send')">
                            <i class="ri-send-plane-2-line"></i>
                        </button>
                        <!-- Stop Button -->
                        <button class="btn-stop" x-show="isGenerating" @click="stopGeneration()" :title="t('stopGeneration')">
                            <i class="ri-stop-circle-line"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Settings Modal -->
    <div class="modal-overlay" x-show="showSettings" x-cloak @click.self="showSettings = false" @keydown.escape.window="showSettings && (showSettings = false)" x-transition role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="settings-modal">
            <!-- Left Nav -->
            <div class="settings-nav" role="tablist" aria-label="Settings navigation">
                <div class="settings-title" id="settings-modal-title" x-text="t('settings')"></div>
                <div class="nav-item" role="tab" :aria-selected="settingsTab === 'models'" :class="{ 'active': settingsTab === 'models' }" @click="settingsTab = 'models'" x-text="t('modelConfig')"></div>
                <div class="nav-item" role="tab" :aria-selected="settingsTab === 'chat'" :class="{ 'active': settingsTab === 'chat' }" @click="settingsTab = 'chat'" x-text="t('chatSettings')"></div>
                <div class="nav-item" role="tab" :aria-selected="settingsTab === 'ui'" :class="{ 'active': settingsTab === 'ui' }" @click="settingsTab = 'ui'" x-text="t('uiSettings')"></div>
                <div class="settings-footer">
                    © 2026 ChatRaw by massif-01, RMinte® AI Technology Co., Ltd.<br>
                    <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener" class="settings-footer-link" x-text="t('apacheLicense')"></a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="settings-content">
                <div class="settings-scroll-area">
                    
                    <!-- Models Tab -->
                    <div x-show="settingsTab === 'models'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('modelConfig')"></h2>
                            <p class="section-desc" x-text="t('modelConfigDesc')"></p>
                        </div>
                        
                        <template x-for="(model, index) in models" :key="model.id || index">
                            <div class="model-card" x-show="model.type === 'chat'">
                                <div class="model-header">
                                    <span class="model-badge" x-text="getModelTypeName(model.type)"></span>
                                    <div class="model-status" :class="model.status || 'unknown'">
                                        <span x-show="model.status === 'success'" class="status-success" x-text="'● ' + t('active')"></span>
                                        <span x-show="model.status === 'error'" class="status-error" x-text="'● ' + t('error')"></span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">API Endpoint</label>
                                    <input type="text" class="input-minimal" x-model="model.api_url">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">API Key (Optional)</label>
                                    <input type="password" class="input-minimal" x-model="model.api_key">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Model ID</label>
                                    <input type="text" class="input-minimal" x-model="model.model_id">
                                </div>

                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('capabilities')"></label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" x-model="model.capability.vision"> <span x-text="t('vision')"></span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" x-model="model.capability.reasoning"> <span x-text="t('reasoning')"></span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" x-model="model.capability.tools"> <span x-text="t('tools')"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('contextLength')"></label>
                                    <input type="number" class="input-minimal" x-model.number="model.context_length" placeholder="8192">
                                </div>

                                <div class="form-group" x-show="model.type === 'chat'">
                                    <label class="form-label" x-text="t('maxOutput')"></label>
                                    <input type="number" class="input-minimal" x-model.number="model.max_output" placeholder="4096">
                                </div>

                                <button class="btn-primary btn-full-width" @click="saveAndVerifyModel(model, index)" :disabled="model.status === 'loading'">
                                    <span x-text="model.status === 'loading' ? t('verifying') : t('saveAndVerify')"></span>
                                </button>
                                <div class="model-verify-msg" x-show="model.verifyMessage" :class="model.status === 'success' ? 'status-success' : 'status-error'" x-text="model.verifyMessage"></div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Chat Settings Tab -->
                    <div x-show="settingsTab === 'chat'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('chatSettings')"></h2>
                            <p class="section-desc" x-text="t('chatSettingsDesc')"></p>
                        </div>

                        <div class="form-group">
                            <div class="toggle-row">
                                <div class="toggle-info">
                                    <label class="form-label" x-text="t('streamOutput')"></label>
                                    <span class="form-sublabel" x-text="t('streamHint')"></span>
                                </div>
                                <button role="switch" :aria-checked="settings.chat_settings.stream" class="toggle-switch" :class="{ 'checked': settings.chat_settings.stream }" @click="settings.chat_settings.stream = !settings.chat_settings.stream">
                                    <span class="toggle-handle"></span>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Temperature: <span x-text="settings.chat_settings.temperature"></span></label>
                            <input type="range" min="0" max="2" step="0.1" x-model.number="settings.chat_settings.temperature">
                            <span class="form-sublabel form-sublabel-inline" x-text="t('temperatureHint')"></span>
                        </div>

                        <!-- Top P Slider Restored -->
                        <div class="form-group">
                            <label class="form-label">Top P: <span x-text="settings.chat_settings.top_p"></span></label>
                            <input type="range" min="0" max="1" step="0.05" x-model.number="settings.chat_settings.top_p">
                            <span class="form-sublabel form-sublabel-inline" x-text="t('topPHint')"></span>
                        </div>

                        <!-- System Prompt -->
                        <div class="form-group">
                            <label class="form-label" x-text="t('systemPrompt')"></label>
                            <span class="form-sublabel form-sublabel-block" x-text="t('systemPromptHint')"></span>
                            <textarea 
                                class="system-prompt-textarea" 
                                x-model="settings.chat_settings.system_prompt"
                                :placeholder="t('systemPromptPlaceholder')"
                                rows="4"
                            ></textarea>
                        </div>
                    </div>

                    <!-- UI Settings Tab -->
                    <div x-show="settingsTab === 'ui'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('uiSettings')"></h2>
                            <p class="section-desc" x-text="t('uiSettingsDesc')"></p>
                        </div>

                        <div class="form-group form-group-lg">
                            <label class="form-label" x-text="t('theme')"></label>
                            <div class="theme-grid">
                                <div class="theme-option" :class="{ 'active': settings.ui_settings.theme_mode === 'light' }" @click="settings.ui_settings.theme_mode = 'light'; applyTheme()">
                                    Light
                                </div>
                                <div class="theme-option" :class="{ 'active': settings.ui_settings.theme_mode === 'dark' }" @click="settings.ui_settings.theme_mode = 'dark'; applyTheme()">
                                    Dark
                                </div>
                            </div>
                        </div>

                        <div class="form-group form-group-lg">
                            <label class="form-label" x-text="t('language')"></label>
                            <div class="theme-grid">
                                <div class="theme-option" :class="{ 'active': lang === 'en' }" @click="setLanguage('en')">English</div>
                                <div class="theme-option" :class="{ 'active': lang === 'zh' }" @click="setLanguage('zh')">中文</div>
                            </div>
                        </div>

                        <div class="form-group form-group-lg">
                            <label class="form-label" x-text="t('logoName')"></label>
                            <div class="logo-upload-area upload-row">
                                <img x-show="settings.ui_settings.logo_data" :src="settings.ui_settings.logo_data" alt="Logo" class="logo-preview-img" width="48" height="48">
                                <label class="btn-secondary btn-compact">
                                    <input type="file" @change="handleLogoUpload($event)" accept="image/*" class="file-input-hidden">
                                    <span x-text="t('uploadLogo')"></span>
                                </label>
                                <button class="btn-delete btn-delete-inline" x-show="settings.ui_settings.logo_data" @click="settings.ui_settings.logo_data = ''" aria-label="Remove logo"><i class="ri-close-circle-fill"></i></button>
                                <input type="text" x-model="settings.ui_settings.logo_text" placeholder="JustChat" class="input-minimal input-flex">
                            </div>
                        </div>

                        <div class="form-group form-group-lg">
                            <label class="form-label" x-text="t('subtitle')"></label>
                            <input type="text" x-model="settings.ui_settings.subtitle" :placeholder="t('defaultSubtitle')" class="input-minimal">
                        </div>

                        <div class="form-group form-group-lg">
                            <label class="form-label" x-text="t('avatars')"></label>
                            
                            <!-- Avatars Row -->
                            <div class="avatars-row">
                                <!-- User Avatar -->
                                <div class="avatar-group">
                                    <div class="avatar-preview-user">
                                        <img x-show="settings.ui_settings.user_avatar" :src="settings.ui_settings.user_avatar" alt="User" width="40" height="40" class="avatar-img">
                                        <i class="ri-user-3-line" x-show="!settings.ui_settings.user_avatar"></i>
                                    </div>
                                    <label class="btn-secondary btn-compact">
                                        <input type="file" @change="handleAvatarUpload($event, 'user')" accept="image/*" class="file-input-hidden">
                                        <span x-text="t('uploadUserAvatar')"></span>
                                    </label>
                                </div>

                                <!-- AI Avatar -->
                                <div class="avatar-group">
                                    <div class="avatar-preview-assistant">
                                        <img x-show="settings.ui_settings.assistant_avatar" :src="settings.ui_settings.assistant_avatar" alt="AI" width="40" height="40" class="avatar-img">
                                        <i class="ri-robot-2-line" x-show="!settings.ui_settings.assistant_avatar"></i>
                                    </div>
                                    <label class="btn-secondary btn-compact">
                                        <input type="file" @change="handleAvatarUpload($event, 'assistant')" accept="image/*" class="file-input-hidden">
                                        <span x-text="t('uploadAIAvatar')"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Modal Actions Footer -->
                <div class="modal-actions-bar">
                    <button class="btn-secondary" @click="showSettings = false" x-text="t('cancel')"></button>
                    <button class="btn-primary" @click="saveAllSettings()" x-text="t('save')"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin Modal -->
    <div class="modal-overlay" x-show="showPlugins" x-cloak @click.self="showPlugins = false" @keydown.escape.window="showPlugins && (showPlugins = false)" x-transition role="dialog" aria-modal="true" aria-labelledby="plugins-modal-title">
        <div class="settings-modal plugin-modal">
            <!-- Left Nav -->
            <div class="settings-nav" role="tablist" aria-label="Plugin navigation">
                <div class="settings-title" id="plugins-modal-title" x-text="t('plugins')"></div>
                <div class="nav-item" role="tab" :aria-selected="pluginTab === 'market'" :class="{ 'active': pluginTab === 'market' }" @click="pluginTab = 'market'; loadPluginMarket()" x-text="t('pluginMarket')"></div>
                <div class="nav-item" role="tab" :aria-selected="pluginTab === 'installed'" :class="{ 'active': pluginTab === 'installed' }" @click="pluginTab = 'installed'" x-text="t('installedPlugins')"></div>
                <div class="nav-item" role="tab" :aria-selected="pluginTab === 'local'" :class="{ 'active': pluginTab === 'local' }" @click="pluginTab = 'local'" x-text="t('installLocalPlugin')"></div>
                <div class="settings-footer">
                    © 2026 ChatRaw by massif-01, RMinte® AI Technology Co., Ltd.<br>
                    <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener" class="settings-footer-link" x-text="t('apacheLicense')"></a>
                </div>
            </div>

            <!-- Right Content -->
            <div class="settings-content">
                <div class="settings-scroll-area">
                    
                    <!-- Plugin Market Tab -->
                    <div x-show="pluginTab === 'market'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('pluginMarket')"></h2>
                            <p class="section-desc" x-text="t('pluginMarketDesc')"></p>
                        </div>
                        
                        <!-- Loading -->
                        <div class="plugin-loading" x-show="pluginMarketLoading">
                            <div class="spinner"></div>
                            <span x-text="t('refreshingMarket')"></span>
                        </div>
                        
                        <!-- Error -->
                        <div class="plugin-error" x-show="pluginMarketError && !pluginMarketLoading">
                            <i class="ri-error-warning-line icon-lg"></i>
                            <span x-text="t('networkError')"></span>
                            <button class="btn-secondary" @click="loadPluginMarket()" x-text="t('retry')"></button>
                        </div>
                        
                        <!-- Plugin Grid -->
                        <div class="plugin-grid" x-show="!pluginMarketLoading && !pluginMarketError">
                            <template x-for="plugin in marketPlugins" :key="plugin.id">
                                <div class="plugin-card">
                                    <img :src="'https://raw.githubusercontent.com/massif-01/ChatRaw/main/Plugins/Plugin_market/' + plugin.folder + '/icon.png'" 
                                         class="plugin-icon" 
                                         width="48" height="48"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23666%22 stroke-width=%222%22><path d=%22M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z%22/></svg>'">
                                    <div class="plugin-info">
                                        <div class="plugin-name" x-text="plugin.name[lang] || plugin.name.en"></div>
                                        <div class="plugin-version" x-text="'v' + plugin.version"></div>
                                        <div class="plugin-desc" x-text="plugin.description[lang] || plugin.description.en"></div>
                                    </div>
                                    <div class="plugin-actions">
                                        <button class="btn-primary btn-sm" 
                                                @click="installPlugin(plugin)" 
                                                :disabled="isPluginInstalled(plugin.id) || pluginInstalling === plugin.id"
                                                x-text="pluginInstalling === plugin.id ? t('installing') : (isPluginInstalled(plugin.id) ? t('installed') : t('install'))">
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="marketPlugins.length === 0" class="plugin-empty" x-text="t('noPluginsAvailable')"></div>
                        </div>
                    </div>
                    
                    <!-- Installed Plugins Tab -->
                    <div x-show="pluginTab === 'installed'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('installedPlugins')"></h2>
                            <p class="section-desc" x-text="t('installedPluginsDesc')"></p>
                        </div>
                        
                        <div class="plugin-list" x-show="installedPlugins.length > 0">
                            <template x-for="plugin in installedPlugins" :key="plugin.id">
                                <div class="plugin-card installed">
                                    <img :src="'/api/plugins/' + encodeURIComponent(plugin.id) + '/icon'" 
                                         class="plugin-icon"
                                         width="48" height="48"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23666%22 stroke-width=%222%22><path d=%22M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z%22/></svg>'">
                                    <div class="plugin-info">
                                        <div class="plugin-name" x-text="plugin.name?.[lang] || plugin.name?.en || plugin.name || plugin.id"></div>
                                        <div class="plugin-version" x-text="'v' + (plugin.version || '1.0.0')"></div>
                                        <div class="plugin-desc" x-text="plugin.description?.[lang] || plugin.description?.en || ''"></div>
                                    </div>
                                    <div class="plugin-actions">
                                        <button class="btn-icon" @click="openPluginSettings(plugin)" :title="t('settings')">
                                            <i class="ri-settings-3-line"></i>
                                        </button>
                                        <button class="btn-icon btn-icon-danger" @click="uninstallPlugin(plugin)" :title="t('uninstall')">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                        <button role="switch" :aria-checked="plugin.enabled" class="toggle-switch" :class="{ 'checked': plugin.enabled }" @click="togglePlugin(plugin)">
                                            <span class="toggle-handle"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="installedPlugins.length === 0" class="plugin-empty" x-text="t('noPluginsInstalled')"></div>
                    </div>
                    
                    <!-- Install Local Plugin Tab -->
                    <div x-show="pluginTab === 'local'">
                        <div class="section-header">
                            <h2 class="section-title" x-text="t('installLocalPlugin')"></h2>
                            <p class="section-desc" x-text="t('installLocalPluginDesc')"></p>
                        </div>
                        
                        <div class="upload-area plugin-upload" @click="$refs.pluginFileInput.click()">
                            <input type="file" x-ref="pluginFileInput" @change="handlePluginUpload($event)" accept=".zip" class="file-input-hidden">
                            <i class="ri-upload-2-line icon-xl"></i>
                            <div x-text="t('selectPluginZip')"></div>
                        </div>
                        
                        <!-- Upload progress -->
                        <div class="plugin-upload-progress" x-show="pluginUploading">
                            <div class="spinner"></div>
                            <span x-text="t('installing')"></span>
                        </div>
                        
                        <div class="plugin-dev-guide">
                            <a href="https://github.com/massif-01/ChatRaw/blob/main/Plugins/README.md" target="_blank" rel="noopener">
                                <i class="ri-external-link-line"></i>
                                <span x-text="t('pluginDevGuide')"></span>
                            </a>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Modal Actions Footer -->
                <div class="modal-actions-bar">
                    <button class="btn-secondary" @click="showPlugins = false" x-text="t('close')"></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Plugin Settings Modal -->
    <div class="modal-overlay" x-show="showPluginSettings" x-cloak @click.self="showPluginSettings = false" x-transition>
        <div class="plugin-settings-modal" :class="{ 'custom-settings-modal': currentPluginSettings?.customSettings }">
            <div class="plugin-settings-header" x-show="!currentPluginSettings?.customSettings">
                <h3 x-text="currentPluginSettings?.name?.[lang] || currentPluginSettings?.name?.en || currentPluginSettings?.id || ''"></h3>
            </div>
            <div class="plugin-settings-content" :class="{ 'custom-settings-content': currentPluginSettings?.customSettings }">
                <!-- Custom Settings Container (for plugins with customSettings: true) -->
                <template x-if="currentPluginSettings?.customSettings">
                    <div id="plugin-custom-settings-area" class="plugin-custom-settings">
                        <div class="plugin-loading-text">Loading...</div>
                    </div>
                </template>
                
                <!-- Standard Settings (only when no customSettings) -->
                <template x-if="!currentPluginSettings?.customSettings && currentPluginSettings?.settings?.length > 0">
                    <div>
                        <template x-for="setting in currentPluginSettings.settings" :key="setting.id">
                            <div class="form-group">
                                <label class="form-label" x-text="setting.label?.[lang] || setting.label?.en || setting.id"></label>
                                
                                <!-- Boolean -->
                                <template x-if="setting.type === 'boolean'">
                                    <button role="switch" :aria-checked="pluginSettingsValues[setting.id]" class="toggle-switch" :class="{ 'checked': pluginSettingsValues[setting.id] }" 
                                         @click="pluginSettingsValues[setting.id] = !pluginSettingsValues[setting.id]">
                                        <span class="toggle-handle"></span>
                                    </button>
                                </template>
                                
                                <!-- String -->
                                <template x-if="setting.type === 'string'">
                                    <input type="text" class="input-minimal" 
                                           x-model="pluginSettingsValues[setting.id]" 
                                           :placeholder="String(setting.default || '')">
                                </template>
                                
                                <!-- Number -->
                                <template x-if="setting.type === 'number'">
                                    <input type="number" class="input-minimal" 
                                           x-model.number="pluginSettingsValues[setting.id]"
                                           :min="setting.min" :max="setting.max"
                                           :placeholder="String(setting.default || '')">
                                </template>
                                
                                <!-- Select -->
                                <template x-if="setting.type === 'select'">
                                    <select class="input-minimal" x-model="pluginSettingsValues[setting.id]">
                                        <template x-for="opt in (setting.options || [])" :key="opt">
                                            <option :value="opt" x-text="opt"></option>
                                        </template>
                                    </select>
                                </template>
                                
                                <!-- Password -->
                                <template x-if="setting.type === 'password'">
                                    <input type="password" class="input-minimal" 
                                           x-model="pluginSettingsValues[setting.id]"
                                           placeholder="••••••••">
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- No Settings (only when no customSettings AND no standard settings) -->
                <template x-if="!currentPluginSettings?.customSettings && (!currentPluginSettings?.settings || currentPluginSettings.settings.length === 0)">
                    <div class="plugin-no-settings" x-text="t('noPluginSettings')"></div>
                </template>
                
                <!-- Proxy/API Key settings (only for non-custom settings plugins) -->
                <template x-if="!currentPluginSettings?.customSettings && currentPluginSettings && currentPluginSettings.proxy && currentPluginSettings.proxy.length > 0">
                    <div class="plugin-proxy-settings">
                        <h4 x-text="t('apiKeySettings')"></h4>
                        <template x-for="proxy in currentPluginSettings.proxy" :key="proxy.id">
                            <div class="form-group">
                                <label class="form-label" x-text="proxy.name?.[lang] || proxy.name?.en || proxy.id"></label>
                                <p class="form-sublabel" x-text="proxy.description?.[lang] || proxy.description?.en || ''"></p>
                                <input type="text" class="input-minimal" 
                                       x-model="pluginApiKeys[proxy.id]"
                                       :placeholder="pluginApiKeys[proxy.id] ? '' : t('enterApiKey')"
                                       @focus="if(pluginApiKeys[proxy.id]?.includes('*')) pluginApiKeys[proxy.id] = ''">
                                <p class="form-hint" x-show="pluginApiKeys[proxy.id]?.includes('*')" x-text="t('apiKeySet')"></p>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div class="plugin-settings-footer" x-show="!currentPluginSettings?.customSettings">
                <button class="btn-secondary" @click="showPluginSettings = false" x-text="t('cancel')"></button>
                <button class="btn-primary" @click="savePluginSettings()" x-text="t('save')"></button>
            </div>
        </div>
    </div>

    <!-- Plugin Fullscreen Modal -->
    <div class="modal-overlay plugin-fullscreen-modal" 
         x-show="pluginFullscreenModal.show" 
         x-cloak
         x-transition
         @click.self="pluginFullscreenModal.closable && closePluginFullscreenModal()"
         @keydown.escape.window="pluginFullscreenModal.show && pluginFullscreenModal.closable && closePluginFullscreenModal()">
        <div class="plugin-fullscreen-content" x-html="pluginFullscreenModal.content"></div>
    </div>

    <!-- Toast -->
    <div class="toast" x-show="toast.show" x-text="toast.message" :class="toast.type" x-transition></div>

    <script src="app.min.js?v=6.0"></script>
</body>
</html>