let hljsLoaded=!1,hljsLoading=!1;async function loadHighlightJS(){if(!hljsLoaded&&!hljsLoading){hljsLoading=!0;try{const t=document.createElement("link");t.rel="stylesheet",t.href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css",document.head.appendChild(t),await loadScript("https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"),await Promise.all([loadScript("https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/python.min.js"),loadScript("https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/javascript.min.js"),loadScript("https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/bash.min.js"),loadScript("https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/json.min.js")]),hljsLoaded=!0,document.querySelectorAll("pre code:not(.hljs)").forEach(t=>{hljs.highlightElement(t)})}catch(t){console.warn("Failed to load highlight.js:",t)}hljsLoading=!1}}function loadScript(t){return new Promise((e,s)=>{const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=s,document.head.appendChild(i)})}const i18n={en:{newChat:"New Chat",clearAllChats:"Clear All",confirmClearAll:"Are you sure you want to delete all chats? This cannot be undone.",allChatsCleared:"All chats cleared",settings:"Settings",delete:"Delete",expand:"Expand",collapse:"Collapse",defaultSubtitle:"Minimalist AI Assistant, Ready to Use",fastResponse:"Fast Response",multiModel:"Multi-Model",knowledgeBase:"Knowledge Base",kbEnabled:"KB Enabled",thinkingMode:"Thinking Mode",thinkingEnabled:"Thinking Enabled",thinkingProcess:"Thinking Process",uploadImage:"Upload Image",uploadDocument:"Upload Document",image:"Image",imageSelected:"Image Selected",documentAttached:"Document Attached",parseUrl:"Parse URL",enterUrl:"Enter URL",parsing:"Parsing...",urlAttached:"URL Attached",parseFailed:"Parse failed",urlPlaceholder:"https://example.com/article",confirm:"OK",ragReferences:"References",relevance:"Relevance",copyMessage:"Copy",copied:"Copied!",inputPlaceholder:"Type a message... (Enter to send, Shift+Enter for new line)",modelConfig:"Models",chatSettings:"Chat",chatSettingsDesc:"Adjust how the AI responds to your inputs.",ragSettings:"RAG",ragSettingsDesc:"Configure retrieval augmented generation parameters.",uiSettings:"Interface",uiSettingsDesc:"Customize the interface appearance.",kbDesc:"Upload documents for RAG context.",modelConfigDesc:"Manage your AI model connections and parameters.",modelType:"Type",chat:"Chat",embedding:"Embedding",reranker:"Reranker",optional:"Optional",contextLength:"Context Length",maxOutput:"Max Output",capabilities:"Capabilities",vision:"Vision",reasoning:"Reasoning",tools:"Tools",saveAndVerify:"Save & Verify",verifying:"Verifying...",verifySuccess:"Connected",verifyFailed:"Connection failed",temperatureHint:"Lower values make output more deterministic, higher values more creative",topPHint:"Nucleus sampling parameter, controls output diversity",streamOutput:"Stream Output",streamHint:"Display AI response in real-time",systemPrompt:"System Prompt",systemPromptHint:"Set instructions for the AI assistant",systemPromptPlaceholder:"You are a helpful assistant...",chunkSize:"Chunk Size",chunkSizeHint:"Number of characters per document chunk",chunkOverlap:"Chunk Overlap",chunkOverlapHint:"Overlap characters between adjacent chunks",topKHint:"Number of relevant documents to retrieve",scoreThreshold:"Score Threshold",scoreThresholdHint:"Documents below this threshold will be filtered",language:"Language",theme:"Theme",light:"Light",dark:"Dark",uploadLogo:"Upload",logoText:"Logo Text",subtitle:"Subtitle",avatars:"Avatars",userAvatar:"User",aiAvatar:"AI",uploadDocument:"Upload Document",noDocuments:"No documents yet. Upload one above.",cancel:"Cancel",save:"Save",uploadSuccess:"uploaded successfully",uploadFailed:"Upload failed",deleteFailed:"Delete failed",saveFailed:"Save failed",settingsSaved:"Settings saved",sendFailed:"Send failed",stopGeneration:"Stop",createChatFailed:"Failed to create chat",documentDeleted:"Document deleted",logoName:"Logo & Name",uploadUserAvatar:"Upload User Avatar",uploadAIAvatar:"Upload AI Avatar",active:"Active",error:"Error",apacheLicense:"Apache 2.0 License",plugins:"Plugins",pluginMarket:"Plugin Market",pluginMarketDesc:"Browse and install plugins from the official market.",installedPlugins:"Installed",installedPluginsDesc:"Manage your installed plugins.",installLocalPlugin:"Install Local",installLocalPluginDesc:"Upload a plugin zip file to install.",refreshingMarket:"Refreshing plugin market...",networkError:"Please check network connection",retry:"Retry",install:"Install",installed:"Installed",installing:"Installing...",installSuccess:"Plugin installed successfully",installFailed:"Install failed",uninstall:"Uninstall",uninstallSuccess:"Plugin uninstalled",uninstallFailed:"Uninstall failed",confirmUninstall:"Are you sure you want to uninstall this plugin?",pluginDisabled:"Plugin disabled",selectPluginZip:"Click or drag to upload plugin (.zip)",pluginDevGuide:"Plugin Development Guide",noPluginsAvailable:"No plugins available",searchPlugins:"Search plugins",noPluginsInstalled:"No plugins installed yet",noPluginSettings:"This plugin has no settings.",apiKeySettings:"API Key Settings",enterApiKey:"Enter API Key",apiKeySet:"API Key is already set. Clear and enter new key to change.",onlyZipSupported:"Only .zip files are supported",close:"Close"},zh:{newChat:"新对话",clearAllChats:"清空所有",confirmClearAll:"确定要删除所有对话吗？此操作无法撤销。",allChatsCleared:"已清空所有对话",settings:"设置",delete:"删除",expand:"展开",collapse:"收起",defaultSubtitle:"极简AI助手，开箱即用",fastResponse:"极速响应",multiModel:"多模型支持",knowledgeBase:"知识库",kbEnabled:"知识库已开启",thinkingMode:"思考模式",thinkingEnabled:"思考模式已开启",thinkingProcess:"思考过程",uploadImage:"上传图片",uploadDocument:"上传文档",image:"图片",imageSelected:"已选择图片",documentAttached:"已附加文档",parseUrl:"解析网页",enterUrl:"输入网址",parsing:"解析中...",urlAttached:"已附加网页",parseFailed:"解析失败",urlPlaceholder:"https://example.com/article",confirm:"确定",ragReferences:"引用来源",relevance:"相关度",copyMessage:"复制",copied:"已复制",inputPlaceholder:"输入消息... (Enter 发送, Shift+Enter 换行)",modelConfig:"模型配置",modelConfigDesc:"管理您的AI模型连接和参数",chatSettings:"聊天设置",chatSettingsDesc:"调整AI对您输入的响应方式",ragSettings:"RAG设置",ragSettingsDesc:"配置检索增强生成 (RAG) 参数",uiSettings:"界面设置",uiSettingsDesc:"自定义界面外观",kbDesc:"上传用于RAG上下文的文档",modelType:"类型",chat:"聊天",embedding:"嵌入",reranker:"重排",optional:"可选",contextLength:"上下文长度",maxOutput:"最大输出",capabilities:"模型能力",vision:"视觉",reasoning:"推理",tools:"工具",saveAndVerify:"保存并验证",verifying:"验证中...",verifySuccess:"连接成功",verifyFailed:"连接失败",temperatureHint:"较低的值使输出更确定，较高的值更有创意",topPHint:"核采样参数，控制输出的多样性",streamOutput:"流式输出",streamHint:"实时显示AI的回复内容",systemPrompt:"系统提示词",systemPromptHint:"设置AI助手的行为指令",systemPromptPlaceholder:"你是一个有帮助的助手...",chunkSize:"文档块大小",chunkSizeHint:"文档分块的字符数",chunkOverlap:"块重叠",chunkOverlapHint:"相邻块之间的重叠字符数",topKHint:"检索相关文档的数量",scoreThreshold:"相似度阈值",scoreThresholdHint:"低于此阈值的文档将被过滤",language:"语言",theme:"主题",light:"浅色",dark:"深色",uploadLogo:"上传",logoText:"Logo文字",subtitle:"副标题",avatars:"头像",userAvatar:"用户",aiAvatar:"AI",uploadDocument:"上传文档",noDocuments:"暂无文档，请在上方上传",cancel:"取消",save:"保存",uploadSuccess:"上传成功",uploadFailed:"上传失败",deleteFailed:"删除失败",saveFailed:"保存失败",settingsSaved:"设置已保存",sendFailed:"发送失败",stopGeneration:"停止",createChatFailed:"创建对话失败",documentDeleted:"文档已删除",logoName:"Logo & 名称",uploadUserAvatar:"上传用户头像",uploadAIAvatar:"上传 AI 头像",active:"活跃",error:"错误",apacheLicense:"Apache 2.0 协议",plugins:"插件",pluginMarket:"插件市场",pluginMarketDesc:"浏览并安装官方市场的插件",installedPlugins:"已安装",installedPluginsDesc:"管理已安装的插件",installLocalPlugin:"本地安装",installLocalPluginDesc:"上传插件 zip 文件进行安装",refreshingMarket:"正在刷新插件市场...",networkError:"请检查网络连接",retry:"重试",install:"安装",installed:"已安装",installing:"安装中...",installSuccess:"插件安装成功",installFailed:"安装失败",uninstall:"卸载",uninstallSuccess:"插件已卸载",uninstallFailed:"卸载失败",confirmUninstall:"确定要卸载此插件吗？",pluginDisabled:"插件已禁用",selectPluginZip:"点击或拖拽上传插件 (.zip)",pluginDevGuide:"插件开发指南",noPluginsAvailable:"暂无可用插件",searchPlugins:"搜索插件",noPluginsInstalled:"暂未安装任何插件",noPluginSettings:"此插件暂无可配置项",apiKeySettings:"API 密钥设置",enterApiKey:"输入 API Key",apiKeySet:"API Key 已设置。清空后输入新密钥可更改。",onlyZipSupported:"仅支持 .zip 文件",close:"关闭"}};function app(){const t="1"===localStorage.getItem("chatraw_sidebar_collapsed"),e=window.matchMedia("(max-width: 768px)").matches;return{lang:localStorage.getItem("justchat_lang")||"en",isMobileView:e,desktopSidebarCollapsed:t,sidebarCollapsed:!!e||t,_resizeRaf:null,showSettings:!1,settingsTab:"models",showSystemPrompt:!1,currentChatId:null,inputMessage:"",useRAG:!1,useThinking:!1,isGenerating:!1,abortController:null,uploadedImage:null,uploadedImageBase64:"",uploadProgress:{show:!1,filename:"",progress:0,status:"",current:0,total:0},showUrlInput:!1,urlInputValue:"",isParsingUrl:!1,parsedUrl:null,parsedUrlTitle:"",attachedDocument:null,isUploadingDocument:!1,showPlugins:!1,pluginTab:"market",marketPlugins:[],installedPlugins:[],pluginMarketLoading:!1,pluginMarketError:!1,pluginMarketSearch:"",pluginInstalling:null,pluginUploading:!1,showPluginSettings:!1,currentPluginSettings:null,pluginSettingsValues:{},pluginApiKeys:{},pluginToolbarButtons:[],showPluginMoreMenu:!1,pluginFullscreenModal:{show:!1,content:"",closable:!0,onClose:null,pluginId:null},pluginHooks:{parse_document:[],parse_url:[],web_search:[],pre_embedding:[],post_retrieval:[],before_send:[],after_receive:[],toolbar_button:[],file_preview:[],custom_action:[],custom_settings:[],transform_input:[],transform_output:[]},loadedPluginDeps:{},chats:[],messages:[],models:[],documents:[],settings:{chat_settings:{temperature:.7,top_p:.9,stream:!0,system_prompt:""},rag_settings:{chunk_size:500,chunk_overlap:50,top_k:3,score_threshold:.5},ui_settings:{logo_data:"",logo_text:"ChatRaw",subtitle:"",theme_mode:"light",user_avatar:"",assistant_avatar:""}},toast:{show:!1,message:"",type:""},t(t){return i18n[this.lang][t]||t},setLanguage(t){this.lang=t,localStorage.setItem("justchat_lang",t)},getModelTypeName(t){return{chat:this.t("chat"),embedding:this.t("embedding"),rerank:this.t("reranker")}[t]||t},async init(){this.initResponsiveLayout(),await this.loadSettings(),await this.loadModels(),await this.loadChats(),await this.loadDocuments(),await this.loadInstalledPlugins(),this.applyTheme(),this.initPluginSystem()},initResponsiveLayout(){this.syncSidebarForViewport(!0);const t=()=>{this._resizeRaf&&cancelAnimationFrame(this._resizeRaf),this._resizeRaf=requestAnimationFrame(()=>{this.syncSidebarForViewport(!1)})};window.addEventListener("resize",t,{passive:!0}),window.addEventListener("orientationchange",t,{passive:!0})},syncSidebarForViewport(t){const e=window.matchMedia("(max-width: 768px)").matches,s=!this.isMobileView&&e,i=this.isMobileView&&!e;this.isMobileView=e,e&&(t||s)?this.sidebarCollapsed=!0:e||!t&&!i||(this.sidebarCollapsed=this.desktopSidebarCollapsed)},toggleSidebar(){this.sidebarCollapsed=!this.sidebarCollapsed,this.isMobileView||(this.desktopSidebarCollapsed=this.sidebarCollapsed,localStorage.setItem("chatraw_sidebar_collapsed",this.sidebarCollapsed?"1":"0"))},openSidebar(){this.sidebarCollapsed=!1},closeSidebar(){this.sidebarCollapsed=!0},closeSidebarOnMobile(){this.isMobileView&&this.closeSidebar()},openSettingsPanel(){this.showSettings=!0,this.closeSidebarOnMobile()},openPluginsPanel(){this.showPlugins=!0,this.loadPluginMarket(),this.closeSidebarOnMobile()},applyTheme(){document.documentElement.setAttribute("data-theme",this.settings.ui_settings.theme_mode)},async loadSettings(){try{const t=await fetch("/api/settings");if(t.ok){const e=await t.json();e.chat_settings&&(this.settings.chat_settings={...this.settings.chat_settings,...e.chat_settings}),e.rag_settings&&(this.settings.rag_settings={...this.settings.rag_settings,...e.rag_settings}),e.ui_settings&&(this.settings.ui_settings={...this.settings.ui_settings,...e.ui_settings})}this.loadLogo()}catch(t){console.error("Failed to load settings:",t)}},async loadLogo(){try{const t=await fetch("/api/settings/logo");if(t.ok){const e=await t.json();e.logo_data&&(this.settings.ui_settings.logo_data=e.logo_data,this.updateFavicon(e.logo_data))}}catch(t){}},async loadModels(){try{const t=await fetch("/api/models");t.ok&&(this.models=await t.json(),this.models.forEach(t=>{t.capability||(t.capability={vision:!1,reasoning:!1,tools:!1})}))}catch(t){console.error("Failed to load models:",t)}},async loadChats(){try{const t=await fetch("/api/chats");t.ok&&(this.chats=await t.json()||[])}catch(t){console.error("Failed to load chats:",t)}},async loadDocuments(){try{const t=await fetch("/api/documents");t.ok&&(this.documents=await t.json()||[])}catch(t){console.error("Failed to load documents:",t)}},async createNewChat(){this.isGenerating&&this.stopGeneration();try{const t=await fetch("/api/chats",{method:"POST"});if(t.ok){const e=await t.json();this.chats.unshift(e),this.chats.length>10&&this.chats.pop(),this.selectChat(e.id),this.closeSidebarOnMobile()}}catch(t){this.showToast(this.t("createChatFailed"),"error")}},async selectChat(t){this.currentChatId=t,await this.loadMessages(t),this.closeSidebarOnMobile()},async loadMessages(t){try{const e=await fetch(`/api/chats/${t}/messages`);e.ok&&(this.messages=await e.json()||[],this.$nextTick(()=>this.scrollToBottom()))}catch(t){console.error("Failed to load messages:",t)}},async deleteChat(t){try{await fetch(`/api/chats/${t}`,{method:"DELETE"}),this.chats=this.chats.filter(e=>e.id!==t),this.currentChatId===t&&(this.currentChatId=null,this.messages=[])}catch(t){this.showToast(this.t("deleteFailed"),"error")}},async clearAllChats(){if(confirm(this.t("confirmClearAll")))try{for(const t of this.chats)await fetch(`/api/chats/${t.id}`,{method:"DELETE"});this.chats=[],this.currentChatId=null,this.messages=[],this.showToast(this.t("allChatsCleared"),"success")}catch(t){this.showToast(this.t("deleteFailed"),"error")}},stopGeneration(){this.abortController&&(this.abortController.abort(),this.abortController=null,this.isGenerating=!1)},async sendMessage(){let t=this.inputMessage.trim();if(!t||this.isGenerating)return;this.inputMessage="",this.isGenerating=!0,this.abortController=new AbortController;const e=await this.callHook("transform_input",t);e?.success&&e.content&&(t=e.content),this.messages.push({role:"user",content:t}),this.$nextTick(()=>this.scrollToBottom());try{let e="",s="";this.parsedUrl&&(e=this.parsedUrl.content,s=this.parsedUrl.url),this.attachedDocument&&(e&&(e+="\n\n---\n\n"),e+=this.attachedDocument.content,s=s?s+", "+this.attachedDocument.filename:this.attachedDocument.filename);let i={chat_id:this.currentChatId,message:t,use_rag:this.useRAG,use_thinking:this.useThinking,image_base64:this.uploadedImageBase64,web_content:e,web_url:s};const n=await this.callHook("before_send",i);n?.success&&n.body&&(i={...i,...n.body}),this.removeUploadedImage(),this.removeParsedUrl(),this.removeAttachedDocument(),this.settings.chat_settings.stream?await this.handleStreamResponse(i):await this.handleNormalResponse(i);const a=this.messages[this.messages.length-1];if(a&&"assistant"===a.role){const t=await this.callHook("after_receive",a);t?.success&&t.content&&(a.content=t.content,this.messages[this.messages.length-1]={...a})}await this.loadChats()}catch(t){"AbortError"===t.name||(console.error("Failed to send message:",t),this.showToast(this.t("sendFailed")+": "+t.message,"error"))}finally{this.isGenerating=!1,this.abortController=null}},async handleStreamResponse(t){const e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:this.abortController?.signal});if(!e.ok){const t=await e.text();throw new Error(t||"Request failed")}const s={role:"assistant",content:"",thinking:"",references:[],showThinking:!1};this.messages.push(s);const i=this.messages.length-1,n=e.body.getReader(),a=new TextDecoder;let o="";try{for(;;){const{done:t,value:e}=await n.read();if(t)break;let l;for(o+=a.decode(e,{stream:!0});-1!==(l=o.indexOf("\n"));){const t=o.slice(0,l).trim();if(o=o.slice(l+1),t)try{const e=JSON.parse(t);if(e.chat_id&&(this.currentChatId=e.chat_id),e.thinking){const t=this.messages[i]?.showThinking||!1;s.thinking+=e.thinking,s.showThinking=t,this.messages[i]={...s},this.$nextTick(()=>this.scrollToBottom())}if(e.content){const t=this.messages[i]?.showThinking||!1;s.content+=e.content,s.showThinking=t,this.messages[i]={...s},this.$nextTick(()=>this.scrollToBottom())}if(e.references){const t=this.messages[i]?.showThinking||!1;s.references=e.references,s.showThinking=t,this.messages[i]={...s},this.$nextTick(()=>this.scrollToBottom())}e.error&&(s.content="Error: "+e.error,this.messages[i]={...s})}catch(t){}}}}catch(t){if("AbortError"!==t.name)throw t;try{await n.cancel()}catch(t){}}},async handleNormalResponse(t){const e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await e.json();if(!e.ok)throw new Error(s.error||"Request failed");!this.currentChatId&&s.chat_id&&(this.currentChatId=s.chat_id),this.messages.push({role:"assistant",content:s.content,thinking:s.thinking||"",references:s.references||[]}),this.$nextTick(()=>this.scrollToBottom())},async handleFileUpload(t){const e=t.target.files[0];if(!e)return;const s=new FormData;s.append("file",e),this.uploadProgress={show:!0,filename:e.name,progress:0,status:"uploading"};try{const t=await fetch("/api/documents",{method:"POST",body:s});if(!t.ok){const e=await t.text();throw new Error(e)}const i=t.body.getReader(),n=new TextDecoder;let a="";for(;;){const{done:t,value:s}=await i.read();if(t)break;let o;for(a+=n.decode(s,{stream:!0});-1!==(o=a.indexOf("\n"));){const t=a.slice(0,o).trim();if(a=a.slice(o+1),t)try{const s=JSON.parse(t);"chunking"===s.status?(this.uploadProgress.status="chunking",this.uploadProgress.total=s.total):"embedding"===s.status?(this.uploadProgress.status="embedding",this.uploadProgress.progress=s.progress,this.uploadProgress.current=s.current,this.uploadProgress.total=s.total):"done"===s.status&&(this.uploadProgress.show=!1,this.showToast(`"${e.name}" ${this.t("uploadSuccess")}`,"success"),await this.loadDocuments())}catch(t){}}}}catch(t){this.uploadProgress.show=!1,this.showToast(this.t("uploadFailed")+": "+t.message,"error")}t.target.value=""},supportsWebP(){const t=document.createElement("canvas");return t.width=1,t.height=1,t.toDataURL("image/webp").startsWith("data:image/webp")},async compressImage(t,e=.5){const s=1024*e*1024;return new Promise((e,i)=>{const n=new Image,a=URL.createObjectURL(t);n.onload=async()=>{URL.revokeObjectURL(a);const o=this.supportsWebP(),l=o?"image/webp":"image/jpeg",r=o?".webp":".jpg";let{width:c,height:d}=n;const h=Math.max(c,d);if(h>1120){const t=1120/h;c=Math.round(c*t),d=Math.round(d*t)}const u=document.createElement("canvas"),g=u.getContext("2d"),p=(t,e,s)=>new Promise(i=>{u.width=t,u.height=e,g.fillStyle="#FFFFFF",g.fillRect(0,0,t,e),g.drawImage(n,0,0,t,e),u.toBlob(t=>i(t),l,s)}),m=[.92,.85,.75,.65,.55,.45,.35,.25];let f=null;for(const t of m){const e=await p(c,d,t);if(e&&e.size<=s){f=e;break}(!f||e&&e.size<f.size)&&(f=e)}if(f&&f.size>s){const t=[.9,.8,.7,.6,.5];for(const e of t){const t=Math.round(c*e),i=Math.round(d*e);for(const e of m){const n=await p(t,i,e);if(n&&n.size<=s){f=n;break}n&&n.size<f.size&&(f=n)}if(f&&f.size<=s)break}}if(!f)return void i(new Error("Compression failed"));const w=t.name.replace(/\.[^.]+$/,r);e(new File([f],w,{type:l}))},n.onerror=()=>{URL.revokeObjectURL(a),i(new Error("Failed to load image"))},n.src=a})},async handleImageUpload(t){const e=t.target.files[0];if(e){try{const t=await this.compressImage(e),s=new FormData;s.append("file",t);const i=await fetch("/api/upload/image",{method:"POST",body:s});if(!i.ok){const t=await i.json();throw new Error(t.error)}{const t=await i.json();this.uploadedImage=e.name,this.uploadedImageBase64=t.base64}}catch(t){this.showToast(this.t("uploadFailed")+": "+t.message,"error")}t.target.value=""}},handleLogoUpload(t){const e=t.target.files[0];if(!e)return;const s=new FileReader;s.onload=t=>{this.settings.ui_settings.logo_data=t.target.result,this.updateFavicon(t.target.result)},s.readAsDataURL(e),t.target.value=""},updateFavicon(t){const e=document.getElementById("favicon");e.href=t||"data:,",document.title=this.settings.ui_settings.logo_text||"ChatRaw"},handleAvatarUpload(t,e){const s=t.target.files[0];if(!s)return;const i=new FileReader;i.onload=t=>{"user"===e?this.settings.ui_settings.user_avatar=t.target.result:this.settings.ui_settings.assistant_avatar=t.target.result},i.readAsDataURL(s),t.target.value=""},removeUploadedImage(){this.uploadedImage=null,this.uploadedImageBase64=""},async handleDocumentUpload(t){const e=t.target.files[0];if(e){this.isUploadingDocument=!0;try{const t="."+(e.name.split(".").pop()||"").toLowerCase(),s=this.pluginHooks.parse_document||[];let i=!1;for(const n of s){if(n._pluginId){const t=this.installedPlugins.find(t=>t.id===n._pluginId);if(!t||!t.enabled)continue}const s=n.fileTypes||[];if(s.includes(t)||s.includes(t.toLowerCase()))try{const t=n._pluginId?this.getPluginSettings(n._pluginId):{},s=await n.handler(e,t);if(s?.success&&s.content){this.attachedDocument={filename:e.name,content:s.content},this.showToast(this.t("documentAttached")+": "+e.name,"success"),i=!0;break}if(s?.error){this.showToast(this.t("uploadFailed")+": "+s.error,"error"),i=!0;break}}catch(t){console.error(`[Plugin ${n._pluginId}] Parse error:`,t)}}if(!i){const t=new FormData;t.append("file",e);const s=await fetch("/api/upload/document",{method:"POST",body:t});if(!s.ok){const t=await s.text();try{const e=JSON.parse(t);throw new Error(e.error||`HTTP ${s.status}`)}catch{throw new Error(`HTTP ${s.status}: ${t.substring(0,100)}`)}}const i=await s.json();i.success?(this.attachedDocument={filename:i.filename,content:i.content},this.showToast(this.t("documentAttached")+": "+i.filename,"success")):this.showToast(this.t("uploadFailed")+": "+(i.error||"Unknown error"),"error")}}catch(t){console.error("Document upload error:",t),this.showToast(this.t("uploadFailed")+": "+(t.message||"Unknown error"),"error")}finally{this.isUploadingDocument=!1}t.target.value=""}},removeAttachedDocument(){this.attachedDocument=null},getDocumentAcceptTypes(){const t=this.installedPlugins.filter(t=>t.enabled&&t.fileTypes).flatMap(t=>t.fileTypes);return[...new Set([".pdf",".docx",".doc",".txt",".md",...t])].join(",")},toggleUrlInput(){this.showUrlInput=!this.showUrlInput,this.showUrlInput&&(this.urlInputValue="",this.$nextTick(()=>{const t=document.querySelector(".url-input-popup input");t&&t.focus()}))},async parseUrl(){const t=this.urlInputValue.trim();if(t){this.isParsingUrl=!0;try{let e=null;const s=this.pluginHooks.parse_url||[];let i=null;for(const t of s)if(t._pluginId){const e=this.installedPlugins.find(e=>e.id===t._pluginId);if(e&&e.enabled){i=e.id;break}}if(i){const s=this.getPluginSettings(i);if("browser"===(s.parser_mode||"browser")){const i=await fetch("/api/fetch-raw-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})}),n=await i.json();if(n.success&&null!=n.html){const i=await this.callHook("parse_url",t,n.html,s);i?.success&&null!=i.title&&null!=i.content&&(e={success:!0,title:i.title,content:i.content,url:t})}}else{const i=await this.callHook("parse_url",t,null,s);i?.success&&null!=i.title&&null!=i.content&&(e={success:!0,title:i.title,content:i.content,url:t})}}if(!e){const s=await fetch("/api/parse-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});e=await s.json()}e.success?(this.parsedUrl={title:e.title,content:e.content,url:e.url},this.parsedUrlTitle=e.title,this.showUrlInput=!1,this.urlInputValue="",this.showToast(this.t("urlAttached")+": "+e.title,"success")):this.showToast(this.t("parseFailed")+": "+(e.error||"Unknown error"),"error")}catch(t){this.showToast(this.t("parseFailed")+": "+t.message,"error")}finally{this.isParsingUrl=!1}}},removeParsedUrl(){this.parsedUrl=null,this.parsedUrlTitle=""},cancelUrlInput(){this.showUrlInput=!1,this.urlInputValue=""},async deleteDocument(t){try{await fetch(`/api/documents/${t}`,{method:"DELETE"}),this.documents=this.documents.filter(e=>e.id!==t),this.showToast(this.t("documentDeleted"),"success")}catch(t){this.showToast(this.t("deleteFailed"),"error")}},async saveAndVerifyModel(t,e){t.status="loading",t.verifyMessage="";try{t.name||(t.name=t.model_id||"Unnamed");const e=await fetch("/api/models",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error("Failed to save");const s=await e.json();s.id&&(t.id=s.id);const i=await fetch("/api/models/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_url:t.api_url,api_key:t.api_key,model_id:t.model_id,type:t.type})}),n=await i.json();i.ok&&n.success?(t.status="success",t.verifyMessage=this.t("verifySuccess")):(t.status="error",t.verifyMessage=n.error||this.t("verifyFailed"))}catch(e){t.status="error",t.verifyMessage=e.message||this.t("verifyFailed")}},async saveAllSettings(){try{await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.settings)});for(const t of this.models)t.name||(t.name=t.model_id||"Unnamed"),await fetch("/api/models",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});this.applyTheme(),this.showSettings=!1,this.showToast(this.t("settingsSaved"),"success"),await this.loadModels()}catch(t){this.showToast(this.t("saveFailed")+": "+t.message,"error")}},async copyMessage(t,e){if(t)try{await navigator.clipboard.writeText(t);const s=e.currentTarget,i=s.querySelector("i"),n=i.className;i.className="ri-check-line",s.classList.add("copied"),setTimeout(()=>{i.className=n,s.classList.remove("copied")},2e3)}catch(e){const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),this.showToast(this.t("copied")||"Copied!")}},renderMarkdown:t=>t?marked.parse(t):"",scrollToBottom(){const t=this.$refs.messagesContainer;t&&(t.scrollTop=t.scrollHeight)},autoResize(t){t.style.height="auto",t.style.height=Math.min(t.scrollHeight,200)+"px"},showToast(t,e=""){this.toast.message=t,this.toast.type=e,this.toast.show=!0,setTimeout(()=>{this.toast.show=!1},3e3)},getSortedPluginButtons(){return[...this.pluginToolbarButtons].filter(t=>{const e=this.installedPlugins?.find(e=>e.id===t.pluginId);return!1!==e?.enabled}).sort((t,e)=>(t.order||100)-(e.order||100))},get visiblePluginButtons(){return this.getSortedPluginButtons().slice(0,5)},get hiddenPluginButtons(){return this.getSortedPluginButtons().slice(5)},getPluginButtonLabel(t){const e=this.lang||"en";return t.label?.[e]||t.label?.en||t.id},async handlePluginButtonClick(t){if(!t.loading)try{await(t.onClick?.(t))}catch(e){console.error(`[Plugin ${t.pluginId}] Button click error:`,e),t.loading=!1}},closePluginFullscreenModal(){if(this.pluginFullscreenModal.onClose)try{this.pluginFullscreenModal.onClose()}catch(t){console.error("[Plugin] Modal onClose error:",t)}this.pluginFullscreenModal.show=!1,this.pluginFullscreenModal.content="",this.pluginFullscreenModal.onClose=null,this.pluginFullscreenModal.pluginId=null},pluginHookRegistry:{},initPluginSystem(){this._currentLoadingPlugin=null;const t=this;window.ChatRawPlugin={hooks:{register:(t,e)=>this.registerHook(t,e),available:()=>Object.keys(this.pluginHooks)},require:t=>this.loadedPluginDeps[t],proxy:{request:t=>this.proxyRequest(t),upload:async(t,e,s,i={},n="file")=>{const a=new FormData;a.append("file",t),a.append("service_id",e),a.append("url",s),a.append("extra_fields",JSON.stringify(i)),a.append("file_field_name",n);try{const t=await fetch("/api/proxy/upload",{method:"POST",body:a});return await t.json()}catch(t){return{success:!1,error:t.message}}}},settings:t=>this.getPluginSettings(t||this._currentLoadingPlugin),utils:{loadScript:e=>t.loadScript(e),loadCSS:e=>t.loadCSS(e),loadHighlightJS:()=>"function"==typeof loadHighlightJS?loadHighlightJS():Promise.resolve(),showToast:(e,s="")=>t.showToast(e,s),getLanguage:()=>t.lang,t:e=>t.t(e),showProgress:(e,s="")=>{t.uploadProgress={show:!0,filename:s,progress:e,status:"processing",current:e,total:100}},hideProgress:()=>{t.uploadProgress={show:!1,filename:"",progress:0,status:"",current:0,total:0}},getCurrentChatId:()=>t.currentChatId,getMessages:()=>[...t.messages],addMessage:(e,s)=>{t.messages.push({role:e,content:s}),t.$nextTick(()=>t.scrollToBottom())}},storage:{get:(e,s=null,i=null)=>{const n=i||t._currentLoadingPlugin;if(!n)return console.warn("[Plugin Storage] No plugin context - pass pluginId as third argument"),s;try{const t=`chatraw_plugin_${n}`,i=JSON.parse(localStorage.getItem(t)||"{}");return e in i?i[e]:s}catch(t){return s}},set:(e,s,i=null)=>{const n=i||t._currentLoadingPlugin;if(!n)return console.warn("[Plugin Storage] No plugin context - pass pluginId as third argument"),!1;try{const t=`chatraw_plugin_${n}`,i=JSON.parse(localStorage.getItem(t)||"{}");i[e]=s;const a=JSON.stringify(i);return a.length>1048576?(console.warn("[Plugin Storage] Storage limit exceeded (1MB)"),!1):(localStorage.setItem(t,a),!0)}catch(t){return console.error("[Plugin Storage] Error:",t),!1}},remove:(e,s=null)=>{const i=s||t._currentLoadingPlugin;if(!i)return!1;try{const t=`chatraw_plugin_${i}`,s=JSON.parse(localStorage.getItem(t)||"{}");return delete s[e],localStorage.setItem(t,JSON.stringify(s)),!0}catch(t){return!1}},clear:(e=null)=>{const s=e||t._currentLoadingPlugin;if(!s)return!1;try{return localStorage.removeItem(`chatraw_plugin_${s}`),!0}catch(t){return!1}},getAll:(e=null)=>{const s=e||t._currentLoadingPlugin;if(!s)return{};try{const t=`chatraw_plugin_${s}`;return JSON.parse(localStorage.getItem(t)||"{}")}catch(t){return{}}}},ui:{registerToolbarButton:(e,s=null)=>{const i=s||t._currentLoadingPlugin||e.pluginId;if(!i)return console.warn("[Plugin UI] Cannot register button: unknown plugin"),!1;if(!e.icon||!/^ri-[a-z0-9-]+$/.test(e.icon))return console.warn(`[Plugin ${i}] Invalid icon format. Must be RemixIcon (ri-xxx-xxx)`),!1;if(!e.id||!e.onClick)return console.warn(`[Plugin ${i}] Button requires id and onClick`),!1;const n=`${i}:${e.id}`,a=t.pluginToolbarButtons.findIndex(t=>t.fullId===n),o={fullId:n,pluginId:i,id:e.id,icon:e.icon,label:e.label||{en:e.id},onClick:e.onClick,order:e.order??100,active:!1,loading:!1};return a>=0?t.pluginToolbarButtons[a]=o:t.pluginToolbarButtons.push(o),!0},unregisterToolbarButton:(e,s=null)=>{const i=s||t._currentLoadingPlugin;if(!i)return!1;const n=`${i}:${e}`,a=t.pluginToolbarButtons.findIndex(t=>t.fullId===n);return a>=0&&(t.pluginToolbarButtons.splice(a,1),!0)},setButtonState:(e,s,i=null)=>{const n=i||t._currentLoadingPlugin;if(!n)return!1;const a=`${n}:${e}`,o=t.pluginToolbarButtons.find(t=>t.fullId===a);return!!o&&(void 0!==s.active&&(o.active=s.active),void 0!==s.loading&&(o.loading=s.loading),!0)},openFullscreenModal:(e,s=null)=>{const i=s||t._currentLoadingPlugin||e?.pluginId;return"string"==typeof e&&(e={content:e}),e?.content?(t.pluginFullscreenModal={show:!0,content:e.content,closable:!1!==e.closable,onClose:e.onClose||null,pluginId:i},!0):(console.warn("[Plugin UI] Cannot open modal: empty content"),!1)},closeFullscreenModal:()=>{t.closePluginFullscreenModal()}}},this.loadEnabledPlugins()},async loadInstalledPlugins(){try{const t=await fetch("/api/plugins");t.ok&&(this.installedPlugins=await t.json())}catch(t){console.error("Failed to load installed plugins:",t)}},async loadEnabledPlugins(){for(const t of this.installedPlugins)t.enabled&&await this.loadPluginJS(t)},async loadPluginJS(t){try{if(t.dependencies)for(const[e,s]of Object.entries(t.dependencies))if(!this.loadedPluginDeps[e])try{if("string"==typeof s&&s.endsWith(".css"))await this.loadCSS(s),this.loadedPluginDeps[e]=!0;else{if(e.startsWith("hljs-"))continue;await this.loadScript(s),"xlsx"===e&&window.XLSX?this.loadedPluginDeps[e]=window.XLSX:"pdfjs"===e&&window.pdfjsLib?this.loadedPluginDeps[e]=window.pdfjsLib:window[e]?this.loadedPluginDeps[e]=window[e]:this.loadedPluginDeps[e]=!0}}catch(s){console.error(`[Plugin] Failed to load dependency ${e} for ${t.id}:`,s)}this._currentLoadingPlugin=t.id;const e=`/api/plugins/${encodeURIComponent(t.id)}/main.js`;await this.loadScript(e),this._currentLoadingPlugin=null,console.log(`[Plugin] Loaded: ${t.id}`)}catch(e){this._currentLoadingPlugin=null,console.error(`[Plugin] Failed to load ${t.id}:`,e)}},loadScript:t=>new Promise((e,s)=>{if(document.querySelector(`script[src="${t}"]`))return void e();const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=()=>s(new Error(`Failed to load script: ${t}`)),document.head.appendChild(i)}),loadCSS:t=>new Promise((e,s)=>{if(document.querySelector(`link[href="${t}"]`))return void e();const i=document.createElement("link");i.rel="stylesheet",i.href=t,i.onload=e,i.onerror=()=>s(new Error(`Failed to load CSS: ${t}`)),document.head.appendChild(i)}),registerHook(t,e){if(!this.pluginHooks[t])return void console.warn(`[Plugin] Unknown hook: ${t}`);const s=this._currentLoadingPlugin,i={...e,_pluginId:s};this.pluginHooks[t].push(i),this.pluginHooks[t].sort((t,e)=>(e.priority||0)-(t.priority||0)),s&&(this.pluginHookRegistry[s]||(this.pluginHookRegistry[s]=[]),this.pluginHookRegistry[s].push({hookName:t,handler:i}))},unregisterPluginHooks(t){const e=this.pluginHookRegistry[t];if(e){for(const{hookName:t,handler:s}of e){const e=this.pluginHooks[t];if(e){const t=e.indexOf(s);-1!==t&&e.splice(t,1)}}delete this.pluginHookRegistry[t]}},async callHook(t,...e){const s=this.pluginHooks[t]||[];for(const i of s){if(i._pluginId){const t=this.installedPlugins.find(t=>t.id===i._pluginId);if(t&&!t.enabled)continue}try{const t=await i.handler(...e);if(t?.success)return t}catch(e){console.error(`[Hook ${t}] Error:`,e)}}return null},getPluginSettings(t){const e=this.installedPlugins.find(e=>e.id===t);if(!e)return{};const s={};if(e.settings)for(const t of e.settings)s[t.id]=t.default;return{...s,...e.settings_values||{}}},async proxyRequest(t){try{const e={service_id:t.serviceId||t.service_id,url:t.url,method:t.method||"POST",headers:t.headers||{},body:t.body||{}},s=await fetch("/api/proxy/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await s.json()}catch(t){return{success:!1,error:t.message}}},async loadPluginMarket(){if(!this.pluginMarketLoading){this.pluginMarketLoading=!0,this.pluginMarketError=!1;try{const t=new AbortController,e=setTimeout(()=>t.abort(),5e3),s=await fetch("https://raw.githubusercontent.com/massif-01/ChatRaw/main/Plugins/Plugin_market/index.json",{signal:t.signal});if(clearTimeout(e),!s.ok)throw new Error("Failed to fetch");const i=await s.json();this.marketPlugins=i.plugins||[]}catch(t){console.error("Failed to load plugin market:",t),this.pluginMarketError=!0}finally{this.pluginMarketLoading=!1}}},isPluginInstalled(t){return this.installedPlugins.some(e=>e.id===t)},get filteredMarketPlugins(){const t=(this.pluginMarketSearch||"").trim().toLowerCase();return t?this.marketPlugins.filter(e=>{const s=(e.name?.en||"").toLowerCase(),i=e.name?.zh||"",n=(e.description?.en||"").toLowerCase(),a=e.description?.zh||"";return s.includes(t)||i.includes(t)||n.includes(t)||a.includes(t)}):this.marketPlugins},async installPlugin(t){this.pluginInstalling=t.id;try{const e=`https://raw.githubusercontent.com/massif-01/ChatRaw/main/Plugins/Plugin_market/${t.folder}`,s=await fetch("/api/plugins/install",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_url:e})}),i=await s.json();if(i.success){this.showToast(this.t("installSuccess"),"success"),await this.loadInstalledPlugins();const e=this.installedPlugins.find(e=>e.id===t.id);e&&await this.loadPluginJS(e)}else this.showToast(this.t("installFailed")+": "+i.error,"error")}catch(t){this.showToast(this.t("installFailed")+": "+t.message,"error")}finally{this.pluginInstalling=null}},async handlePluginUpload(t){const e=t.target?.files?.[0];e&&await this.uploadPluginFile(e,t.target)},async handlePluginDrop(t){const e=t.dataTransfer?.files?.[0];e&&(t.dataTransfer.clearData(),await this.uploadPluginFile(e))},async uploadPluginFile(t,e){if(t.name.endsWith(".zip")){this.pluginUploading=!0;try{const e=new FormData;e.append("file",t);const s=await fetch("/api/plugins/upload",{method:"POST",body:e}),i=await s.json();if(i.success){this.showToast(this.t("installSuccess"),"success"),await this.loadInstalledPlugins();const t=this.installedPlugins.find(t=>t.id===i.plugin_id);t&&await this.loadPluginJS(t)}else this.showToast(this.t("installFailed")+": "+i.error,"error")}catch(t){this.showToast(this.t("installFailed")+": "+t.message,"error")}finally{this.pluginUploading=!1,e&&(e.value="")}}else this.showToast(this.t("onlyZipSupported"),"error")},async togglePlugin(t){const e=!t.enabled;try{(await fetch(`/api/plugins/${encodeURIComponent(t.id)}/toggle`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:e})})).ok&&(t.enabled=e,e?(await this.loadPluginJS(t),this.showToast(this.t("settingsSaved"),"success")):(this.unregisterPluginHooks(t.id),this.pluginToolbarButtons=this.pluginToolbarButtons.filter(e=>e.pluginId!==t.id),this.pluginFullscreenModal.pluginId===t.id&&this.closePluginFullscreenModal(),this.showToast(this.t("pluginDisabled"),"success")))}catch(t){this.showToast(this.t("saveFailed"),"error")}},async openPluginSettings(t){this.currentPluginSettings=t;const e={};if(t.settings)for(const s of t.settings)e[s.id]=s.default;if(Object.assign(e,t.settings_values||{}),this.pluginSettingsValues=e,this.pluginApiKeys={},t.proxy&&t.proxy.length>0)try{const e=await fetch("/api/plugins/api-keys");if(e.ok){const s=(await e.json()).api_keys||{};for(const e of t.proxy)s[e.id]&&(this.pluginApiKeys[e.id]=s[e.id])}}catch(t){console.error("Failed to load API keys:",t)}this.showPluginSettings=!0,t.customSettings&&setTimeout(()=>{window.dispatchEvent(new CustomEvent("plugin-settings-open",{detail:{pluginId:t.id,customSettings:!0}}))},50)},async savePluginSettings(){if(this.currentPluginSettings)try{if(!(await fetch(`/api/plugins/${encodeURIComponent(this.currentPluginSettings.id)}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({settings:this.pluginSettingsValues})})).ok)throw new Error("Failed to save settings");for(const[t,e]of Object.entries(this.pluginApiKeys))e&&!e.includes("*")&&await fetch("/api/plugins/api-key",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service_id:t,api_key:e})});const t=this.installedPlugins.find(t=>t.id===this.currentPluginSettings.id);t&&(t.settings_values={...this.pluginSettingsValues}),this.showPluginSettings=!1,this.showToast(this.t("settingsSaved"),"success")}catch(t){this.showToast(this.t("saveFailed"),"error")}},async uninstallPlugin(t){if(t&&confirm(this.t("confirmUninstall")))try{this.unregisterPluginHooks(t.id),this.pluginToolbarButtons=this.pluginToolbarButtons.filter(e=>e.pluginId!==t.id),this.pluginFullscreenModal.pluginId===t.id&&this.closePluginFullscreenModal();const e=await fetch(`/api/plugins/${encodeURIComponent(t.id)}`,{method:"DELETE"});if(e.ok)this.showPluginSettings=!1,this.currentPluginSettings=null,this.showToast(this.t("uninstallSuccess"),"success"),await this.loadInstalledPlugins();else{const t=await e.json().catch(()=>({}));this.showToast(this.t("uninstallFailed")+(t.error?": "+t.error:""),"error")}}catch(t){this.showToast(this.t("uninstallFailed"),"error")}}}}marked.setOptions({highlight:function(t,e){if(hljsLoaded||hljsLoading||loadHighlightJS(),"undefined"!=typeof hljs){if(e&&hljs.getLanguage(e))try{return hljs.highlight(t,{language:e}).value}catch(t){}return hljs.highlightAuto(t).value}return t.replace(/</g,"&lt;").replace(/>/g,"&gt;")},breaks:!0,gfm:!0});